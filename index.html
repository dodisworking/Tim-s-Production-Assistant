<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tim's Production Minion - Screening Scheduler</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* Animated Starfield Background */
        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .star {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            animation: twinkle 2s infinite ease-in-out;
        }

        .star:nth-child(odd) {
            animation-delay: 0.5s;
        }

        .star:nth-child(3n) {
            animation-delay: 1s;
        }

        .star:nth-child(5n) {
            animation-delay: 1.5s;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Bouncing Rocket Ship Animation */
        .rocket-ship {
            position: fixed;
            font-size: 40px;
            z-index: 0;
            pointer-events: none;
            transition: transform 0.1s linear;
            will-change: transform;
        }

        /* Comet Animation */
        .comet {
            position: fixed;
            font-size: 50px;
            z-index: 0;
            pointer-events: none;
            will-change: transform, left, top;
            opacity: 0;
        }

        .comet.active {
            opacity: 1;
            transition: opacity 0.3s ease-in;
        }

        /* Satellite Animation */
        .satellite {
            position: fixed;
            font-size: 45px;
            z-index: 0;
            pointer-events: none;
            will-change: transform, left, top;
            opacity: 0;
        }

        .satellite.active {
            opacity: 1;
            transition: opacity 0.3s ease-in;
        }

        /* Main Container */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        /* Admin Button */
        .admin-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .admin-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        /* Form Steps */
        .step {
            display: none;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
            min-height: 100vh;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .step.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #fff, #ccc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .step h2 {
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: #fff;
        }

        .step .step-question {
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: #fff;
        }

        .step p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: #ccc;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 30px;
        }

        input[type="text"], input[type="email"], input[type="url"], textarea, select {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus, input[type="email"]:focus, input[type="url"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #fff;
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
        }

        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Food Options */
        .food-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            max-width: 800px;
        }

        .food-option {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
        }

        .food-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.6);
            transform: scale(1.05);
        }

        .food-option.selected {
            background: rgba(0, 255, 0, 0.3);
            border-color: #00ff00;
            transform: scale(1.05);
        }

        .food-option span {
            display: block;
            font-size: 18px;
        }

        .other-food-input {
            margin-top: 20px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Calendar Styles */
        .calendar-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-nav:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .calendar-month {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .calendar-day-header {
            text-align: center;
            padding: 10px;
            font-weight: bold;
            color: #ccc;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .calendar-day.available {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid rgba(0, 255, 0, 0.5);
        }

        .calendar-day.available:hover {
            background: rgba(0, 255, 0, 0.4);
            transform: scale(1.1);
        }

        .calendar-day.has-submissions {
            background: rgba(255, 255, 0, 0.3) !important;
            border: 2px solid #ffff00 !important;
            position: relative;
        }

        .submission-info {
            position: absolute;
            bottom: 2px;
            left: 2px;
            right: 2px;
            font-size: 10px;
            color: #ffff00;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 3px;
            padding: 1px;
            max-height: 20px;
            overflow: hidden;
        }

        .submission-item {
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);
        }

        .calendar-day.selected {
            background: rgba(255, 255, 0, 0.3);
            border: 2px solid #ffff00;
        }

        .calendar-day.other-month {
            color: rgba(255, 255, 255, 0.3);
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .time-slot {
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .time-slot:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .time-slot.selected {
            background: rgba(0, 255, 0, 0.3);
            border-color: #00ff00;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(45deg, #fff, #ccc);
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Admin Panel */
        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            padding: 40px;
            overflow-y: auto;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-content {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .admin-header-buttons {
            display: flex;
            gap: 15px;
        }

        .admin-clear-btn {
            background: rgba(255, 0, 0, 0.3);
            border: 1px solid #ff0000;
            color: #fff;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .admin-clear-btn:hover {
            background: rgba(255, 0, 0, 0.5);
        }

        .admin-debug-btn {
            background: rgba(0, 255, 255, 0.3);
            border: 1px solid #00ffff;
            color: #fff;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .admin-debug-btn:hover {
            background: rgba(0, 255, 255, 0.5);
        }

        .admin-close {
            background: rgba(255, 0, 0, 0.3);
            border: 1px solid #ff0000;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-close:hover {
            background: rgba(255, 0, 0, 0.5);
        }

        .admin-section {
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .admin-section h3 {
            margin-bottom: 20px;
            color: #fff;
            font-size: 1.5rem;
        }

        /* Admin Panel Tabs */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .admin-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.3s;
        }

        .admin-tab.active {
            color: #fff;
            border-bottom-color: #2196F3;
        }

        .admin-tab:hover {
            color: #fff;
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        /* Outlook Calendar invite Assistant */
        .outlook-assistant-container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .outlook-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .outlook-header h2 {
            font-size: 36px;
            color: #fff;
            margin: 0 0 10px 0;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .outlook-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
            margin: 0;
        }

        .outlook-report-content {
            min-height: 400px;
        }

        /* Poster Generation Modal */
        .poster-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .poster-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .poster-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 32px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.2s;
        }

        .poster-close:hover {
            color: #333;
        }

        #posterPreview canvas {
            max-width: 100%;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .loading-outlook {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
            padding: 60px 20px;
        }

        .month-section {
            margin-bottom: 50px;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .month-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 12px 12px 0 0;
            margin-bottom: 0;
            font-size: 24px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .month-header::before {
            content: 'ðŸ“†';
            font-size: 32px;
        }

        .bookings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 12px 12px;
            backdrop-filter: blur(10px);
        }

        .booking-card-outlook {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 25px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .booking-card-outlook::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .booking-card-outlook:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .booking-card-outlook:hover::before {
            transform: scaleX(1);
        }

        .booking-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .booking-lock-icon {
            font-size: 24px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .booking-company-name {
            font-size: 22px;
            font-weight: 700;
            color: #fff;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .booking-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .booking-detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 15px;
        }

        .booking-detail-item .icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .booking-detail-item strong {
            color: #fff;
            font-weight: 600;
        }

        .booking-detail-item a {
            color: #4CAF50;
            text-decoration: none;
            transition: color 0.2s;
        }

        .booking-detail-item a:hover {
            color: #8BC34A;
            text-decoration: underline;
        }

        .empty-month {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 18px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .no-bookings {
            text-align: center;
            padding: 80px 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 20px;
        }

        .no-bookings-icon {
            font-size: 64px;
            margin-bottom: 20px;
            display: block;
        }

        /* Admin Calendar */
        .admin-calendar-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .admin-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .admin-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .admin-calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 5px;
            min-height: 80px;
        }

        .admin-calendar-day:hover {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
            transform: scale(1.05);
        }

        .admin-calendar-day.has-slots {
            background: rgba(0, 255, 0, 0.3);
            border-color: #00ff00;
        }

        .admin-calendar-day.has-slots:hover {
            background: rgba(0, 255, 0, 0.5);
        }

        .admin-calendar-day.has-submissions {
            background: rgba(255, 255, 0, 0.5) !important;
            border: 3px solid #ffeb3b !important;
            position: relative;
            box-shadow: 0 0 8px rgba(255, 235, 59, 0.6) !important;
        }
        
        .admin-calendar-day.has-submissions:hover {
            background: rgba(255, 255, 0, 0.7) !important;
            box-shadow: 0 0 12px rgba(255, 235, 59, 0.8) !important;
        }

        .admin-submission-info {
            font-size: 10px;
            color: #333;
            text-align: center;
            border-radius: 3px;
            max-height: 40px;
            overflow: hidden;
        }

        .admin-submission-item {
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);
        }

        .admin-calendar-day.has-approved {
            background: rgba(0, 255, 0, 0.4) !important;
            border: 2px solid #00ff00 !important;
            position: relative;
        }

        .admin-approved-info {
            position: absolute;
            bottom: 2px;
            left: 2px;
            right: 2px;
            font-size: 10px;
            color: #00ff00;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 3px;
            padding: 1px;
            max-height: 20px;
            overflow: hidden;
        }

        .admin-approved-item {
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);
        }

        /* Submission Details Modal */
        .submission-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .submission-details-modal.active {
            display: flex;
        }

        .submission-details-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .submission-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .submission-details-header h2 {
            color: #fff;
            margin: 0;
        }

        .close-btn {
            background: rgba(255, 0, 0, 0.3);
            border: 1px solid #ff0000;
            color: #fff;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .submission-detail-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .submission-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .submission-detail-header strong {
            color: #fff;
            font-size: 18px;
        }

        .submission-detail-content p {
            color: #ccc;
            margin: 8px 0;
        }

        .submission-detail-content a {
            color: #00ff00;
            text-decoration: none;
        }

        .submission-detail-item.approved {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }

        .approved-badge {
            background: rgba(0, 255, 0, 0.3);
            color: #00ff00;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid #00ff00;
        }

        .admin-calendar-day.other-month {
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }

        .admin-calendar-day.other-month:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            transform: none;
        }

        .admin-day-number {
            font-weight: bold;
            font-size: 14px;
        }

        .admin-time-slots {
            font-size: 9px;
            color: #00ff00;
            margin-top: 2px;
            text-align: center;
            max-height: 50px;
            overflow-y: auto;
            width: 100%;
        }

        .admin-time-slots span {
            display: block;
            margin: 1px 0;
            padding: 1px 2px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 3px;
            font-weight: 500;
        }

        /* Time Picker Modal */
        .time-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .time-picker-modal.active {
            display: flex;
        }

        .time-picker-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .time-picker-header {
            margin-bottom: 30px;
        }

        .time-picker-header h3 {
            color: #fff;
            font-size: 1.8rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #fff, #ccc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .time-picker-date {
            color: #ccc;
            font-size: 1.1rem;
        }

        .time-picker-slots {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
        }

        .time-slot-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .time-slot-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.02);
        }

        .time-slot-item .time {
            font-weight: bold;
            color: #00ff00;
            font-size: 16px;
        }

        .time-slot-item .remove-btn {
            background: rgba(255, 0, 0, 0.3);
            border: 1px solid #ff0000;
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .time-slot-item .remove-btn:hover {
            background: rgba(255, 0, 0, 0.5);
            transform: scale(1.1);
        }

        /* Custom Time Input */
        .custom-time-input {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 15px;
            color: #fff;
            font-size: 16px;
            width: 100%;
            margin-bottom: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .custom-time-input:focus {
            outline: none;
            border-color: #fff;
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
        }

        .custom-time-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .time-picker-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .time-picker-btn {
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-picker-btn.primary {
            background: linear-gradient(45deg, #fff, #ccc);
            color: #000;
        }

        .time-picker-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .time-picker-btn:hover {
            transform: scale(1.05);
        }

        /* Confirmation Modal */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 8000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .confirm-modal.active {
            display: flex;
        }

        .confirm-modal-content {
            background: rgba(20, 20, 20, 0.95);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .confirm-modal-content h3 {
            color: #fff;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .confirm-modal-content p {
            color: #ccc;
            font-size: 1rem;
            margin-bottom: 25px;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 12px 30px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirm-btn.delete {
            background: #ff4444;
            color: white;
        }

        .confirm-btn.delete:hover {
            background: #cc0000;
            transform: scale(1.05);
        }

        .confirm-btn.cancel {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .confirm-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes posterSpinner {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .calendar-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #fff;
            z-index: 100;
            border-radius: 10px;
        }

        .calendar-loading .loading-spinner {
            margin-bottom: 10px;
        }

        .calendar-loading span {
            display: block;
            font-size: 14px;
            color: #ccc;
        }

        /* Success Modal */
        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 7000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .success-modal.active {
            display: flex;
        }

        .success-modal-content {
            background: rgba(20, 20, 20, 0.95);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(0, 255, 0, 0.3);
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .success-modal-content h3 {
            color: #00ff00;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .success-modal-content h3.error {
            color: #ff4444;
        }

        .success-modal-content p {
            color: #ccc;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .success-modal-content button {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .success-modal-content button:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .add-time-section {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .add-time-section h4 {
            color: #00ff00;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        /* Clock Interface */
        .clock-container {
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .clock-wrapper {
            text-align: center;
        }

        .clock-label {
            color: #fff;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .clock {
            width: 120px;
            height: 120px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clock:hover {
            border-color: rgba(255, 255, 255, 0.6);
            transform: scale(1.05);
        }

        .clock-face {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .clock-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .clock-hand {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 40px;
            background: #00ff00;
            transform-origin: bottom center;
            transform: translate(-50%, -100%) rotate(0deg);
            border-radius: 2px;
            z-index: 5;
            transition: transform 0.2s ease-out;
            cursor: pointer;
        }

        .clock-hand:hover {
            background: #00ff88;
            transform: translate(-50%, -100%) scale(1.1);
        }

        .clock-numbers {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .clock-number {
            position: absolute;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            font-weight: bold;
            transform: translate(-50%, -50%);
        }

        .am-pm-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .am-pm-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
        }

        .am-pm-btn.active {
            background: rgba(0, 255, 0, 0.3);
            border-color: #00ff00;
        }

        .am-pm-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .am-pm-btn.active:hover {
            background: rgba(0, 255, 0, 0.4);
        }

        .time-display {
            color: #00ff00;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
        }

        .clock-separator {
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            align-self: center;
            margin-top: 40px;
        }

        .submission-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #00ff00;
        }

        .submission-item.approved {
            border-left-color: #ffff00;
        }

        .submission-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .submission-detail {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
        }

        .submission-detail strong {
            color: #fff;
            display: block;
            margin-bottom: 5px;
        }

        .submission-actions {
            display: flex;
            gap: 10px;
        }

        .btn-approve {
            background: rgba(0, 255, 0, 0.3);
            border: 1px solid #00ff00;
            color: #fff;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-approve:hover {
            background: rgba(0, 255, 0, 0.5);
        }

        .btn-approve:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-reject {
            background: rgba(255, 0, 0, 0.3);
            border: 1px solid #ff0000;
            color: #fff;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .btn-reject:hover {
            background: rgba(255, 0, 0, 0.5);
        }

        .btn-ai-invitation {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-ai-invitation:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-ai-invitation:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* AI Invitation Modal */
        .invitation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .invitation-modal.active {
            display: flex;
        }

        .invitation-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .invitation-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff4444;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .invitation-close:hover {
            background: #cc0000;
        }

        .invitation-content h2 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 24px;
        }

        .invitation-loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 16px;
        }

        .invitation-text {
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 15px;
            color: #333;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin: 20px 0;
        }

        .invitation-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-copy-invitation {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .btn-copy-invitation:hover {
            background: #45a049;
        }

        .btn-close-invitation {
            background: #666;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .btn-close-invitation:hover {
            background: #555;
        }

        .btn-reject:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-edit {
            background: rgba(0, 150, 255, 0.3);
            border: 1px solid #0096ff;
            color: #fff;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        .btn-edit:hover {
            background: rgba(0, 150, 255, 0.5);
        }

        .btn-remove {
            background: rgba(255, 100, 0, 0.3);
            border: 1px solid #ff6400;
            color: #fff;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-remove:hover {
            background: rgba(255, 100, 0, 0.5);
        }

        .submission-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .add-more-slots-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
            text-align: center;
        }

        .btn-add-more {
            background: rgba(0, 255, 0, 0.3);
            border: 1px solid #00ff00;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-add-more:hover {
            background: rgba(0, 255, 0, 0.5);
            transform: translateY(-2px);
        }

        /* Spaceship Animation */
        @keyframes spaceshipShake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            75% { transform: translateX(5px) rotate(2deg); }
        }

        @keyframes spaceshipLiftOff {
            0% { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            50% { 
                transform: translateY(-20px) scale(1.1);
                opacity: 0.8;
            }
            100% { 
                transform: translateY(-100px) scale(0.8);
                opacity: 0;
            }
        }

        /* Rocket Loading Animation for Time Picker */
        @keyframes rocketShake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            10% { transform: translateX(-3px) rotate(-1deg); }
            20% { transform: translateX(3px) rotate(1deg); }
            30% { transform: translateX(-3px) rotate(-1deg); }
            40% { transform: translateX(3px) rotate(1deg); }
            50% { transform: translateX(-2px) rotate(-0.5deg); }
            60% { transform: translateX(2px) rotate(0.5deg); }
            70% { transform: translateX(-2px) rotate(-0.5deg); }
            80% { transform: translateX(2px) rotate(0.5deg); }
            90% { transform: translateX(0) rotate(0deg); }
        }

        @keyframes rocketLiftOff {
            0% {
                transform: translate(0, 0) rotate(0deg) scale(1);
                opacity: 1;
            }
            20% {
                transform: translate(12px, -25px) rotate(6deg) scale(1.05);
            }
            40% {
                transform: translate(-18px, -60px) rotate(-4deg) scale(1.08);
            }
            60% {
                transform: translate(20px, -100px) rotate(10deg) scale(1.1);
            }
            80% {
                transform: translate(-10px, -140px) rotate(-2deg) scale(1.12);
            }
            100% {
                transform: translate(35px, -190px) rotate(12deg) scale(1.15);
                opacity: 0;
            }
        }

        @keyframes fireFadeIn {
            0% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0.8; transform: scale(1.1); }
        }

        /* Rejection Modal */
        .rejection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .rejection-modal.active {
            display: flex;
        }

        .rejection-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 500px;
            width: 90%;
        }

        .rejection-header {
            margin-bottom: 30px;
        }

        .rejection-header h3 {
            color: #fff;
            font-size: 1.8rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff0000, #ff6666);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .rejection-subtitle {
            color: #ccc;
            font-size: 1rem;
        }

        .rejection-message {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 15px;
            color: #fff;
            font-size: 16px;
            width: 100%;
            margin-bottom: 20px;
            min-height: 120px;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .rejection-message:focus {
            outline: none;
            border-color: #ff0000;
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
        }

        .rejection-message::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .rejection-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .rejection-btn {
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .rejection-btn.confirm {
            background: linear-gradient(45deg, #ff0000, #cc0000);
            color: #fff;
        }

        .rejection-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .rejection-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px 10px;
            }
            
            .step h1 {
                font-size: 2rem;
            }
            
            .step h2 {
                font-size: 1.5rem;
            }
            
            .calendar-grid {
                gap: 2px;
            }
            
            .admin-panel {
                padding: 20px;
            }
        }

        .poster-modal-body {
            display: flex;
            gap: 24px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .poster-preview-column {
            flex: 1 1 60%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .poster-details-column {
            flex: 1 1 320px;
            max-height: 70vh;
            overflow-y: auto;
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.8), 0 6px 18px rgba(0,0,0,0.08);
        }

        .poster-details-column h3 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 18px;
            color: #333;
        }

        .poster-bookings-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .poster-booking-item {
            background: white;
            border-radius: 10px;
            padding: 14px 16px;
            box-shadow: 0 4px 14px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .poster-booking-item strong {
            display: block;
            font-size: 16px;
            color: #1f1f1f;
            margin-bottom: 6px;
        }

        .poster-booking-item span {
            display: block;
            font-size: 14px;
            color: #555;
        }

        @media (max-width: 900px) {
            .poster-modal-body {
                flex-direction: column;
            }

            .poster-details-column {
                width: 100%;
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <!-- Starfield Background -->
    <div class="starfield" id="starfield"></div>

    <!-- Rocket Ship Animation -->
    <div class="rocket-ship" id="rocketShip">ðŸš€</div>

    <!-- Comet Animation -->
    <div class="comet" id="comet">â˜„ï¸</div>

    <!-- Satellite Animation -->
    <div class="satellite" id="satellite">ðŸ›°ï¸</div>

    <!-- Admin Button -->
    <button class="admin-btn" onclick="showAdminPanel()">Admin</button>

    <!-- Time Picker Modal -->
    <div class="time-picker-modal" id="timePickerModal">
        <div class="time-picker-content">
            <div class="time-picker-header">
                <h3>Manage Time Slots</h3>
                <div class="time-picker-date" id="timePickerDate"></div>
            </div>
            
            <div class="time-picker-slots" id="timePickerSlots">
                <!-- Existing time slots will be populated here -->
            </div>
            
            <div class="add-time-section">
                <h4>Add New Time Slot</h4>
                <div class="clock-container">
                    <div class="clock-wrapper">
                        <div class="clock-label">Start Time</div>
                        <div class="clock" id="startClock">
                            <div class="clock-face">
                                <div class="clock-numbers" id="startClockNumbers"></div>
                                <div class="clock-hand" id="startClockHand"></div>
                                <div class="clock-center"></div>
                            </div>
                        </div>
                        <div class="am-pm-selector">
                            <button class="am-pm-btn active" onclick="setAmPm('start', 'AM')">AM</button>
                            <button class="am-pm-btn" onclick="setAmPm('start', 'PM')">PM</button>
                        </div>
                        <div class="time-display" id="startTimeDisplay">12:00 AM</div>
                    </div>
                    
                    <div class="clock-separator">to</div>
                    
                    <div class="clock-wrapper">
                        <div class="clock-label">End Time</div>
                        <div class="clock" id="endClock">
                            <div class="clock-face">
                                <div class="clock-numbers" id="endClockNumbers"></div>
                                <div class="clock-hand" id="endClockHand"></div>
                                <div class="clock-center"></div>
                            </div>
                        </div>
                        <div class="am-pm-selector">
                            <button class="am-pm-btn active" onclick="setAmPm('end', 'AM')">AM</button>
                            <button class="am-pm-btn" onclick="setAmPm('end', 'PM')">PM</button>
                        </div>
                        <div class="time-display" id="endTimeDisplay">12:00 AM</div>
                    </div>
                </div>
            </div>
            
            <div class="time-picker-buttons">
                <button class="time-picker-btn primary" onclick="addTimeFromModal()">Add Time</button>
                <button class="time-picker-btn secondary" onclick="closeTimePicker()">Close</button>
            </div>
        </div>
    </div>

    <!-- Rejection Modal (hidden - no longer used) -->
    <div class="rejection-modal" id="rejectionModal" style="display: none;">
        <div class="rejection-content">
            <div class="rejection-header">
                <h3>Reject Submission</h3>
                <div class="rejection-subtitle" id="rejectionSubtitle">Please provide a reason for rejection</div>
            </div>
            
            <textarea class="rejection-message" id="rejectionMessage" placeholder="Enter your rejection message here... This will be included in the email sent to the company."></textarea>
            
            <div class="rejection-buttons">
                <button class="rejection-btn confirm" onclick="confirmRejection()">Send Rejection Message</button>
                <button class="rejection-btn cancel" onclick="cancelRejection()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-content">
            <div class="admin-header">
                <h2>Admin Panel - Tim's Production Minion</h2>
                <div class="admin-header-buttons">
                    <button class="admin-close" onclick="hideAdminPanel()">Close</button>
                </div>
            </div>

            <!-- Admin Tabs -->
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('calendar', event)">Calendar Management</button>
                <button class="admin-tab" onclick="switchAdminTab('outlook', event)">Outlook Calendar invite Assistant</button>
            </div>

            <!-- Calendar Management Tab -->
            <div class="admin-tab-content active" id="calendarTab">
                <div class="admin-section">
                    <h3>Manage Time Slots - Click on any date to add slots</h3>
                    <div class="admin-calendar-container">
                        <div class="admin-calendar-header">
                            <button class="calendar-nav" onclick="changeAdminMonth(-1)">â€¹</button>
                            <div class="calendar-month" id="adminCalendarMonth"></div>
                            <button class="calendar-nav" onclick="changeAdminMonth(1)">â€º</button>
                        </div>
                        <div class="admin-calendar-grid" id="adminCalendarGrid"></div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3>Submissions</h3>
                    <div id="submissionsList"></div>
                </div>
            </div>

            <!-- Outlook Calendar invite Assistant Tab -->
            <div class="admin-tab-content" id="outlookTab">
                <div class="outlook-assistant-container">
                    <div class="outlook-header">
                        <h2>ðŸ“… Approved Submissions Report</h2>
                        <p class="outlook-subtitle">Visual overview of all locked-in bookings</p>
                    </div>
                    <div id="outlookReportContent" class="outlook-report-content">
                        <div class="loading-outlook">Loading approved submissions...</div>
                    </div>
                </div>
            </div>
            
            <!-- Poster Generation Modal -->
            <div id="posterModal" class="poster-modal" style="display: none;">
                <div class="poster-modal-content">
                    <span class="poster-close" onclick="closePosterModal()">&times;</span>
                    <h2 id="posterModalTitle" style="margin-bottom: 20px; color: #333;">ðŸŽ¨ Generating Poster...</h2>
                    <div class="poster-modal-body">
                        <div id="posterPreview" class="poster-preview-column" style="text-align: center;"></div>
                        <div class="poster-details-column">
                            <div class="poster-details-header">
                                <h3>Confirmed Bookings</h3>
                                <button class="btn-confirm-poster" onclick="confirmPoster()">Confirm Poster</button>
                            </div>
                            <div id="posterBookingsList" class="poster-bookings-list">Loading bookings...</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Step 1: Company Name -->
        <div class="step active" id="step1">
            <h1>Welcome to Ogilvy</h1>
            <h2>This is our AI production assistant</h2>
            <div class="step-question">First what is the name of your company?</div>
            <div class="form-group">
                <input type="text" id="companyName" placeholder="Enter your company name">
            </div>
            <button class="btn" onclick="nextStep()" id="step1Btn" disabled>Continue</button>
        </div>

        <!-- Step 2: Email -->
        <div class="step" id="step2">
            <h2>What is your email address?</h2>
            <div class="form-group">
                <input type="email" id="email" placeholder="Enter your email">
            </div>
            <button class="btn btn-secondary" onclick="prevStep()">Back</button>
            <button class="btn" onclick="nextStep()" id="step2Btn" disabled>Continue</button>
        </div>

        <!-- Step 3: Calendar -->
        <div class="step" id="step3">
            <h2>When would you like to come to Ogilvy?</h2>
            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="changeMonth(-1)">â€¹</button>
                    <div class="calendar-month" id="calendarMonth"></div>
                    <button class="calendar-nav" onclick="changeMonth(1)">â€º</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div class="time-slots" id="timeSlots"></div>
            </div>
            <button class="btn btn-secondary" onclick="prevStep()">Back</button>
            <button class="btn" onclick="nextStep()" id="step3Btn" disabled>Continue</button>
        </div>

        <!-- Step 4: Website -->
        <div class="step" id="step4">
            <h2>What is your company's website link?</h2>
            <div class="form-group">
                <input type="url" id="website" placeholder="https://yourcompany.com">
            </div>
            <button class="btn btn-secondary" onclick="prevStep()">Back</button>
            <button class="btn" onclick="nextStep()" id="step4Btn" disabled>Continue</button>
        </div>

        <!-- Step 5: Food -->
        <div class="step" id="step5">
            <h2>What type of food are you planning to bring?</h2>
            <div class="form-group">
                <div class="food-options">
                    <div class="food-option" onclick="selectFood('Pizza')">
                        <span>ðŸ• Pizza</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Sandwiches')">
                        <span>ðŸ¥ª Sandwiches</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Catering Platters')">
                        <span>ðŸ½ï¸ Catering Platters</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Sushi')">
                        <span>ðŸ£ Sushi</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Mexican Food')">
                        <span>ðŸŒ® Mexican Food</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Italian Food')">
                        <span>ðŸ Italian Food</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Asian Food')">
                        <span>ðŸ¥¢ Asian Food</span>
                    </div>
                    <div class="food-option" onclick="selectFood('BBQ')">
                        <span>ðŸ– BBQ</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Salads')">
                        <span>ðŸ¥— Salads</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Appetizers')">
                        <span>ðŸ§€ Appetizers</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Desserts')">
                        <span>ðŸ° Desserts</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Breakfast Items')">
                        <span>ðŸ¥ž Breakfast Items</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Mediterranean')">
                        <span>ðŸ¥™ Mediterranean</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Indian Food')">
                        <span>ðŸ› Indian Food</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Thai Food')">
                        <span>ðŸœ Thai Food</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Kosher')">
                        <span>âœ¡ï¸ Kosher</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Vegetarian/Vegan')">
                        <span>ðŸŒ± Vegetarian/Vegan</span>
                    </div>
                    <div class="food-option" onclick="selectFood('Other')">
                        <span>ðŸ“ Other</span>
                    </div>
                </div>
                <div class="other-food-input" id="otherFoodInput" style="display: none;">
                    <input type="text" id="otherFoodText" placeholder="Please specify...">
                </div>
            </div>
            <button class="btn btn-secondary" onclick="prevStep()">Back</button>
            <button class="btn" onclick="nextStep()" id="step5Btn" disabled>Continue</button>
        </div>

        <!-- Step 6: Review -->
        <div class="step" id="step6">
            <h2>Review Your Submission</h2>
            <div class="submission-item">
                <div class="submission-details">
                    <div class="submission-detail">
                        <strong>Company:</strong>
                        <span id="reviewCompany"></span>
                    </div>
                    <div class="submission-detail">
                        <strong>Email:</strong>
                        <span id="reviewEmail"></span>
                    </div>
                    <div class="submission-detail">
                        <strong>Date & Time:</strong>
                        <span id="reviewDateTime"></span>
                    </div>
                    <div class="submission-detail">
                        <strong>Website:</strong>
                        <span id="reviewWebsite"></span>
                    </div>
                    <div class="submission-detail">
                        <strong>Food:</strong>
                        <span id="reviewFood"></span>
                    </div>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="prevStep()">Back</button>
            <button class="btn" onclick="submitForm()">Confirm Submission</button>
        </div>

        <!-- Step 7: Confirmation -->
        <div class="step" id="step7">
            <h1>Thank You!</h1>
            <p>Your submission has been received. Please note that this time is not final and things can change.</p>
            <p>You will receive an email confirmation when we confirm your time.</p>
            <button class="btn" onclick="resetForm()">Submit Another Request</button>
        </div>
    </div>

    <script src="./poster-images.js"></script>
    <script>
        // Global variables
        let currentStep = 1;
        let selectedDate = null;
        let selectedTimeSlot = null;
        let selectedFood = null;
        
        // Initialize to January 2026
        let currentMonth = 0; // 0 = January
        let currentYear = 2026;
        let adminCurrentMonth = 0; // Admin calendar month (January)
        let adminCurrentYear = 2026; // Admin calendar year
        const ADMIN_PASSWORD = 'Tim';
        
        // Calendar data cache - preload once to avoid refetching on month changes
        let calendarDataCache = {
            timeSlots: null,
            submissions: null,
            approvedBookings: null,
            loaded: false
        };
        
        // Admin calendar data cache - preload once to avoid refetching on month changes
        let adminCalendarDataCache = {
            timeSlots: null,
            submissions: null,
            approvedBookings: null,
            loaded: false
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeStarfield();
            initializeRocketShip();
            initializeComet();
            initializeSatellite();
            initializeForm();
            // Preload calendar data in the background immediately
            preloadCalendarData();
        });

        // Create animated starfield
        function initializeStarfield() {
            const starfield = document.getElementById('starfield');
            const numStars = 100;

            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                // Random position
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                
                // Random size
                const size = Math.random() * 3 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                
                // Random animation delay
                star.style.animationDelay = Math.random() * 2 + 's';
                star.style.animationDuration = (Math.random() * 2 + 1) + 's';
                
                starfield.appendChild(star);
            }
        }

        // Bouncing Rocket Ship Animation
        function initializeRocketShip() {
            const rocket = document.getElementById('rocketShip');
            if (!rocket) return;

            // Initial position (random)
            let x = Math.random() * (window.innerWidth - 40);
            let y = Math.random() * (window.innerHeight - 40);
            
            // Rocket size
            const rocketSize = 40;
            
            // Velocity (fixed launch angle with increased speed)
            const baseSpeed = Math.random() * 1.2 + 0.8;
            const speedMultiplier = 1.18 * 1.18; // additional 18% boost (total ~39% faster than original)
            const speed = baseSpeed * speedMultiplier;
            const launchAngleDegrees = 36;
            const launchAngleRadians = launchAngleDegrees * (Math.PI / 180);
            
            let velocityX = Math.cos(launchAngleRadians) * speed;
            let velocityY = Math.sin(launchAngleRadians) * speed;
            
            // Randomize vertical direction while keeping the 36Â° rightward angle
            if (Math.random() > 0.5) {
                velocityY = -velocityY;
            }
            
            function animateRocket() {
                // Update position
                x += velocityX;
                y += velocityY;
                
                // Check boundaries and bounce
                const hitLeft = x <= 0;
                const hitRight = x >= window.innerWidth - rocketSize;
                const hitTop = y <= 0;
                const hitBottom = y >= window.innerHeight - rocketSize;
                
                // Bounce off edges
                if (hitLeft || hitRight) {
                    velocityX = -velocityX;
                    x = Math.max(0, Math.min(window.innerWidth - rocketSize, x));
                }
                
                if (hitTop || hitBottom) {
                    velocityY = -velocityY;
                    y = Math.max(0, Math.min(window.innerHeight - rocketSize, y));
                }
                
                // Calculate rotation angle based on velocity direction
                // atan2 gives angle from positive x-axis (0Â° = pointing right)
                // Rocket points at 3pm (pointing right = 0Â°) by default, so use atan2 directly
                // Rotate starting position 20 degrees clockwise
                const angle = (Math.atan2(velocityY, velocityX) * (180 / Math.PI)) + 20;
                
                // Apply position and rotation
                rocket.style.left = x + 'px';
                rocket.style.top = y + 'px';
                rocket.style.transform = `rotate(${angle}deg)`;
                
                // Continue animation
                requestAnimationFrame(animateRocket);
            }
            
            // Start animation
            animateRocket();
            
            // Handle window resize
            window.addEventListener('resize', () => {
                // Keep rocket within bounds if window is resized
                x = Math.min(x, window.innerWidth - rocketSize);
                y = Math.min(y, window.innerHeight - rocketSize);
            });
        }

        // Comet Animation - flies across screen every 36 seconds
        function initializeComet() {
            const comet = document.getElementById('comet');
            if (!comet) return;

            const cometSize = 50;
            const animationDuration = 5000; // 5 seconds to cross screen (slower)
            
            function flyComet() {
                // Random direction angle (0 to 360 degrees)
                const angle = Math.random() * 360;
                const angleRad = angle * (Math.PI / 180);
                
                // Calculate start and end positions (from one edge to opposite edge)
                const distance = Math.sqrt(window.innerWidth ** 2 + window.innerHeight ** 2);
                
                // Start from one edge based on angle
                let startX, startY;
                
                // Determine starting edge based on angle
                if (angle >= 0 && angle < 90) {
                    // Top or right edge
                    startX = Math.random() < 0.5 ? -cometSize : window.innerWidth + cometSize;
                    startY = Math.random() < 0.5 ? -cometSize : Math.random() * window.innerHeight;
                } else if (angle >= 90 && angle < 180) {
                    // Top or left edge
                    startX = Math.random() < 0.5 ? -cometSize : Math.random() * window.innerWidth;
                    startY = -cometSize;
                } else if (angle >= 180 && angle < 270) {
                    // Bottom or left edge
                    startX = -cometSize;
                    startY = Math.random() < 0.5 ? window.innerHeight + cometSize : Math.random() * window.innerHeight;
                } else {
                    // Bottom or right edge
                    startX = window.innerWidth + cometSize;
                    startY = Math.random() < 0.5 ? window.innerHeight + cometSize : Math.random() * window.innerHeight;
                }
                
                // Calculate end position (opposite side of screen)
                const endX = startX + Math.cos(angleRad) * distance;
                const endY = startY + Math.sin(angleRad) * distance;
                
                // Set initial position
                comet.style.left = startX + 'px';
                comet.style.top = startY + 'px';
                
                // Calculate rotation angle (comet points in direction of travel)
                // Comet emoji points at 3pm (90Â° to the right) by default, so we subtract 90Â°
                const rotationAngle = angle - 90;
                comet.style.transform = `rotate(${rotationAngle}deg)`;
                
                // Show comet
                comet.classList.add('active');
                
                // Animate comet across screen
                const startTime = Date.now();
                
                function animateComet() {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / animationDuration, 1);
                    
                    // Ease-out function for smooth deceleration
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    
                    // Calculate current position
                    const currentX = startX + (endX - startX) * easeOut;
                    const currentY = startY + (endY - startY) * easeOut;
                    
                    comet.style.left = currentX + 'px';
                    comet.style.top = currentY + 'px';
                    
                    if (progress < 1) {
                        requestAnimationFrame(animateComet);
                    } else {
                        // Hide comet when animation completes
                        comet.classList.remove('active');
                    }
                }
                
                animateComet();
            }
            
            // Start first comet at 36 seconds, then every 36 seconds after
            setTimeout(() => {
                flyComet();
                setInterval(flyComet, 36000); // 36 seconds = 36000 milliseconds
            }, 36000); // First comet after 36 seconds
        }

        // Satellite Animation - crosses screen slowly, then 18 seconds later from another direction
        function initializeSatellite() {
            const satellite = document.getElementById('satellite');
            if (!satellite) return;

            const satelliteSize = 45;
            const animationDuration = 8000; // 8 seconds to cross screen (slower)
            const delayBetweenPasses = 18000; // 18 seconds between passes
            
            function flySatellite() {
                // Random direction angle (0 to 360 degrees)
                const angle = Math.random() * 360;
                const angleRad = angle * (Math.PI / 180);
                
                // Calculate start and end positions (from one edge to opposite edge)
                const distance = Math.sqrt(window.innerWidth ** 2 + window.innerHeight ** 2);
                
                // Start from one edge based on angle
                let startX, startY;
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                
                // Determine starting edge based on angle
                if (angle >= 0 && angle < 90) {
                    // Top or right edge
                    startX = Math.random() < 0.5 ? -satelliteSize : window.innerWidth + satelliteSize;
                    startY = Math.random() < 0.5 ? -satelliteSize : Math.random() * window.innerHeight;
                } else if (angle >= 90 && angle < 180) {
                    // Top or left edge
                    startX = Math.random() < 0.5 ? -satelliteSize : Math.random() * window.innerWidth;
                    startY = -satelliteSize;
                } else if (angle >= 180 && angle < 270) {
                    // Bottom or left edge
                    startX = -satelliteSize;
                    startY = Math.random() < 0.5 ? window.innerHeight + satelliteSize : Math.random() * window.innerHeight;
                } else {
                    // Bottom or right edge
                    startX = window.innerWidth + satelliteSize;
                    startY = Math.random() < 0.5 ? window.innerHeight + satelliteSize : Math.random() * window.innerHeight;
                }
                
                // Calculate end position (opposite side of screen)
                const endX = startX + Math.cos(angleRad) * distance;
                const endY = startY + Math.sin(angleRad) * distance;
                
                // Set initial position
                satellite.style.left = startX + 'px';
                satellite.style.top = startY + 'px';
                
                // Calculate rotation angle (satellite points in direction of travel)
                // Satellite emoji points at 3pm (90Â° to the right) by default, so we subtract 90Â°
                const rotationAngle = angle - 90;
                satellite.style.transform = `rotate(${rotationAngle}deg)`;
                
                // Show satellite
                satellite.classList.add('active');
                
                // Animate satellite across screen
                const startTime = Date.now();
                
                function animateSatellite() {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / animationDuration, 1);
                    
                    // Linear movement for slow, steady crossing
                    const currentX = startX + (endX - startX) * progress;
                    const currentY = startY + (endY - startY) * progress;
                    
                    satellite.style.left = currentX + 'px';
                    satellite.style.top = currentY + 'px';
                    
                    if (progress < 1) {
                        requestAnimationFrame(animateSatellite);
                    } else {
                        // Hide satellite when animation completes
                        satellite.classList.remove('active');
                    }
                }
                
                animateSatellite();
            }
            
            // Start first satellite immediately, then every 18 seconds after it completes
            function scheduleNextSatellite() {
                flySatellite();
                setTimeout(scheduleNextSatellite, animationDuration + delayBetweenPasses);
            }
            
            // Start first satellite
            scheduleNextSatellite();
        }

        // Initialize form validation
        function initializeForm() {
            // Step 1: Company name validation
            document.getElementById('companyName').addEventListener('input', function() {
                const btn = document.getElementById('step1Btn');
                btn.disabled = this.value.trim().length === 0;
            });

            // Step 2: Email validation
            document.getElementById('email').addEventListener('input', function() {
                const btn = document.getElementById('step2Btn');
                btn.disabled = this.value.trim().length === 0;
            });

            // Step 4: Website validation
            document.getElementById('website').addEventListener('input', function() {
                const btn = document.getElementById('step4Btn');
                btn.disabled = this.value.trim().length === 0;
            });

            // Step 4: Enter key to continue
            document.getElementById('website').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !document.getElementById('step4Btn').disabled) {
                    nextStep();
                }
            });

            // Step 5: Food validation - handled by selectFood function
        }

        // Navigation functions
        async function nextStep() {
            if (currentStep < 7) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep++;
                document.getElementById(`step${currentStep}`).classList.add('active');
                
                // Preload calendar data when entering step 3 (calendar step)
                if (currentStep === 3) {
                    if (!calendarDataCache.loaded) {
                        await preloadCalendarData();
                    }
                    // Update calendar display (will use cached data)
                    await updateCalendar();
                }
                
                // Update review step if we're going to step 6
                if (currentStep === 6) {
                    updateReviewStep();
                }
            }
        }

        async function prevStep() {
            if (currentStep > 1) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep--;
                document.getElementById(`step${currentStep}`).classList.add('active');
                
                // Update calendar when going back to step 3 (will use cached data)
                if (currentStep === 3 && calendarDataCache.loaded) {
                    await updateCalendar();
                }
            }
        }

        // Preload calendar data once when entering step 3
        async function preloadCalendarData() {
            // If cache is loaded and has valid data, use it
            if (calendarDataCache.loaded && 
                calendarDataCache.timeSlots != null && 
                calendarDataCache.submissions != null && 
                calendarDataCache.approvedBookings != null) {
                console.log('ðŸ“‹ Calendar data already loaded, using cache');
                return;
            }
            
            console.log('ðŸ“¥ Preloading all calendar data...');
            try {
                // Fetch all data once
                const timeSlotsPromise = getTimeSlots();
                const submissionsPromise = getSubmissions();
                const approvedBookingsPromise = getApprovedBookings();
                
                [calendarDataCache.timeSlots, calendarDataCache.submissions, calendarDataCache.approvedBookings] = await Promise.all([
                    timeSlotsPromise,
                    submissionsPromise,
                    approvedBookingsPromise
                ]);
                
                console.log(`âœ… Preloaded ${calendarDataCache.timeSlots.length} time slots`);
                console.log(`âœ… Preloaded ${calendarDataCache.submissions.length} submissions`);
                console.log(`âœ… Preloaded ${calendarDataCache.approvedBookings.length} approved bookings from Accepted sheet`);
                
                // Only mark as loaded if we got valid data
                if (calendarDataCache.timeSlots != null && 
                    calendarDataCache.submissions != null && 
                    calendarDataCache.approvedBookings != null) {
                    calendarDataCache.loaded = true;
                    console.log('âœ… Calendar data preloaded successfully');
                } else {
                    console.warn('âš ï¸ Preload completed but some data is null');
                }
            } catch (error) {
                console.error('âŒ Error preloading calendar data:', error);
                // Set to empty arrays but mark as loaded to prevent infinite retries
                calendarDataCache.timeSlots = [];
                calendarDataCache.submissions = [];
                calendarDataCache.approvedBookings = [];
                calendarDataCache.loaded = true;
            }
        }

        // Calendar functions
        async function updateCalendar() {
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];

            document.getElementById('calendarMonth').textContent = 
                `${monthNames[currentMonth]} ${currentYear}`;

            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // Show rocket loading animation if data hasn't been loaded yet
            if (!calendarDataCache.loaded) {
                showRocketLoadingAnimation();
                
                // Preload data if not already loaded
                await preloadCalendarData();
                
                // Hide animation after data is loaded
                hideRocketLoadingAnimation();
            }

            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });

            // Get first day of month and number of days
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

            // Add previous month's trailing days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = daysInPrevMonth - i;
                calendarGrid.appendChild(day);
            }

            // Use cached data - ensure we have valid data (not null/undefined)
            const allTimeSlots = (calendarDataCache.timeSlots != null) ? calendarDataCache.timeSlots : [];
            const allSubmissions = (calendarDataCache.submissions != null) ? calendarDataCache.submissions : [];
            const allApprovedBookings = (calendarDataCache.approvedBookings != null) ? calendarDataCache.approvedBookings : [];
            
            console.log(`ðŸ“† Using cached data: ${allTimeSlots.length} time slots, ${allSubmissions.length} submissions, ${allApprovedBookings.length} approved bookings`);

            // Add current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const normalizedCompareDate = normalizeDate(dateStr);
                
                // Check if this date has available time slots from TimeSlots sheet
                try {
                    // Filter slots for this date from the pre-fetched array
                    const slotsForDate = allTimeSlots.filter(slot => {
                        if (!slot.date) return false;
                        const normalizedSlotDate = normalizeDate(slot.date);
                        const matches = normalizedSlotDate === normalizedCompareDate || slot.date === dateStr;
                        if (matches) {
                            console.log(`âœ… Date match found for ${dateStr}: slot ${slot.id} with date ${slot.date} (normalized: ${normalizedSlotDate})`);
                        }
                        return matches;
                    });
                    
                    if (slotsForDate.length > 0) {
                        console.log(`ðŸ“… ${dateStr} has ${slotsForDate.length} raw time slot(s) from TimeSlots sheet`);
                        
                        // Filter available slots (remove booked/pending ones for user view)
                        // Filter out slots with pending submissions
                        const pendingForDate = allSubmissions.filter(s => {
                            const status = (s.status || 'PENDING').toString().trim().toUpperCase();
                            const isPending = !s.approved && !s.rejected && status !== 'APPROVED' && status !== 'REJECTED';
                            return isPending && (normalizeDate(s.date) === normalizedCompareDate || s.date === dateStr);
                        });
                        
                        // Filter out slots with approved bookings
                        const approvedForDate = allApprovedBookings.filter(b => 
                            normalizeDate(b.date) === normalizedCompareDate || b.date === dateStr
                        );
                        
                        const availableSlots = slotsForDate.filter(slot => {
                            const slotTime = `${slot.startTime || ''}-${slot.endTime || ''}`.trim();
                            const hasPending = pendingForDate.some(s => {
                                const subTime = `${s.startTime || ''}-${s.endTime || ''}`.trim();
                                return subTime && slotTime && subTime === slotTime;
                            });
                            const hasApproved = approvedForDate.some(b => {
                                const bookTime = `${b.startTime || ''}-${b.endTime || ''}`.trim();
                                return bookTime && slotTime && bookTime === slotTime;
                            });
                            return !hasPending && !hasApproved;
                        });
                        
                        if (availableSlots && availableSlots.length > 0) {
                            console.log(`âœ… ${dateStr} has ${availableSlots.length} AVAILABLE time slot(s) - marking as available`);
                            dayElement.classList.add('available');
                            dayElement.onclick = () => selectDate(dateStr, availableSlots);
                            console.log(`âœ… Day ${day} marked as available with ${availableSlots.length} slot(s)`);
                        } else {
                            console.log(`âš ï¸ ${dateStr} has ${slotsForDate.length} slot(s) from TimeSlots sheet but all are booked/filtered out`);
                        }
                    } else {
                        // Debug: log if no slots found for this date
                        if (allTimeSlots.length > 0) {
                            console.log(`ðŸ” No slots found for ${dateStr} (searched in ${allTimeSlots.length} total slots)`);
                        }
                    }
                } catch (error) {
                    console.error(`âŒ Error processing date ${dateStr}:`, error);
                    console.error('Error details:', error.message, error.stack);
                    // Continue to next day even if this one fails
                }

                calendarGrid.appendChild(dayElement);
            }

            // Add next month's leading days
            const totalCells = calendarGrid.children.length;
            const remainingCells = 42 - totalCells; // 6 rows * 7 days = 42 cells
            for (let day = 1; day <= remainingCells; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.textContent = day;
                calendarGrid.appendChild(dayElement);
            }
            
            // Count how many days have available slots
            const availableDays = calendarGrid.querySelectorAll('.calendar-day.available').length;
            console.log('âœ… Calendar update complete');
            console.log(`ðŸ“Š Calendar stats: ${availableDays} days with available time slots`);
            
            if (availableDays === 0 && allTimeSlots.length > 0) {
                console.warn('âš ï¸ WARNING: Time slots exist in Google Sheets but no days are marked as available!');
                console.warn('This might be due to date format mismatches or filtering issues.');
            } else if (allTimeSlots.length === 0) {
                console.warn('âš ï¸ WARNING: No time slots found in Google Sheets. Add time slots in the admin panel.');
            }
        }

        async function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            await updateCalendar();
        }

        function selectDate(dateStr, timeSlots) {
            selectedDate = dateStr;
            selectedTimeSlot = null;
            
            // Update visual selection
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            event.target.classList.add('selected');

            // Show time slots
            const timeSlotsContainer = document.getElementById('timeSlots');
            timeSlotsContainer.innerHTML = '';
            document.getElementById('step3Btn').disabled = true;

            timeSlots.forEach(slot => {
                const slotElement = document.createElement('div');
                slotElement.className = 'time-slot';
                
                // Format the time display properly
                let displayTime = 'N/A';
                if (slot.startTime && slot.endTime) {
                    const startFormatted = formatTimeDisplay(slot.startTime);
                    const endFormatted = formatTimeDisplay(slot.endTime);
                    displayTime = `${startFormatted} - ${endFormatted}`;
                } else if (slot.time) {
                    displayTime = formatTimeDisplay(slot.time);
                }
                
                slotElement.textContent = displayTime;
                slotElement.onclick = () => selectTimeSlot(slotElement, slot);
                timeSlotsContainer.appendChild(slotElement);
            });
        }

        function selectTimeSlot(element, slot) {
            selectedTimeSlot = slot;
            
            // Update visual selection
            document.querySelectorAll('.time-slot').forEach(s => {
                s.classList.remove('selected');
            });
            element.classList.add('selected');
            document.getElementById('step3Btn').disabled = false;
        }

        // Food selection function
        function selectFood(foodType) {
            selectedFood = foodType;
            
            // Update visual selection
            document.querySelectorAll('.food-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.food-option').classList.add('selected');
            
            // Show other input if "Other" is selected
            const otherInput = document.getElementById('otherFoodInput');
            if (foodType === 'Other') {
                otherInput.style.display = 'block';
                document.getElementById('otherFoodText').focus();
            } else {
                otherInput.style.display = 'none';
                document.getElementById('otherFoodText').value = '';
            }
            
            // Enable continue button
            document.getElementById('step5Btn').disabled = false;
        }

        // Data Management Functions - Using Google Sheets
        // ============================================
        // GOOGLE SHEETS BACKEND - CLEAN IMPLEMENTATION
        // ============================================
        
        // Google Sheets API Configuration
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbyjAU_VPvpLasMAm-TKjtbzVFH2jZips2bHQI2ynOfhsp-A94NVDPYJ3H05qEorW5id/exec';

        // ============================================
        // GET OPERATIONS (Fetch Data)
        // ============================================
        
        async function getTimeSlots() {
            try {
                console.log('ðŸ” Fetching time slots from:', GOOGLE_SHEETS_URL + '?type=timeslots');
                const response = await fetch(GOOGLE_SHEETS_URL + '?type=timeslots');
                const text = await response.text();
                console.log('ðŸ“¥ Raw response:', text.substring(0, 200));
                
                const data = JSON.parse(text);
                console.log('ðŸ“Š Parsed data:', data);
                
                if (data.success && data.timeSlots) {
                    console.log(`âœ… Successfully fetched ${data.timeSlots.length} time slots`);
                    return data.timeSlots;
                } else if (data.error) {
                    console.error('âŒ Apps Script error:', data.error);
                    return [];
                } else {
                    console.warn('âš ï¸ Unexpected response format:', data);
                    return data.timeSlots || [];
                }
            } catch (error) {
                console.error('âŒ Error fetching time slots:', error);
                console.error('Error details:', error.message, error.stack);
                return [];
            }
        }

        async function getSubmissions() {
            try {
                console.log('ðŸ” Fetching submissions from:', GOOGLE_SHEETS_URL + '?type=submissions');
                const response = await fetch(GOOGLE_SHEETS_URL + '?type=submissions');
                
                if (!response.ok) {
                    console.error('âŒ HTTP error:', response.status, response.statusText);
                    return [];
                }
                
                const text = await response.text();
                console.log('ðŸ“¥ Raw submissions response (full):', text);
                console.log('ðŸ“¥ Raw submissions response length:', text.length);
                
                if (!text || text.trim() === '') {
                    console.error('âŒ Empty response from server');
                    return [];
                }
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (parseError) {
                    console.error('âŒ Failed to parse JSON:', parseError);
                    console.error('Response text:', text);
                    return [];
                }
                
                console.log('ðŸ“Š Parsed submissions data:', data);
                console.log('ðŸ“Š Data keys:', Object.keys(data));
                
                if (data.success && data.submissions) {
                    console.log(`âœ… Successfully fetched ${data.submissions.length} submissions`);
                    if (data.submissions.length > 0) {
                        console.log('Sample submission:', data.submissions[0]);
                        console.log('All submission IDs:', data.submissions.map(s => s.id));
                    } else {
                        console.warn('âš ï¸ Submissions array is empty!');
                    }
                    return data.submissions;
                } else if (data.error) {
                    console.error('âŒ Apps Script error:', data.error);
                    return [];
                } else if (data.submissions) {
                    // If submissions exist but success is false or missing
                    console.warn('âš ï¸ Response has submissions but success is false:', data);
                    console.log(`Returning ${data.submissions.length} submissions anyway`);
                    return data.submissions;
                } else {
                    console.error('âŒ Unexpected response format:', data);
                    console.error('Response structure:', JSON.stringify(data, null, 2));
                    return [];
                }
            } catch (error) {
                console.error('âŒ Error fetching submissions:', error);
                console.error('Error details:', error.message, error.stack);
                return [];
            }
        }

        async function getApprovedBookings() {
            try {
                // Use dedicated backend endpoint for approved bookings
                console.log('ðŸ” Fetching approved bookings from:', GOOGLE_SHEETS_URL + '?type=approved');
                const response = await fetch(GOOGLE_SHEETS_URL + '?type=approved');
                
                if (!response.ok) {
                    console.error('âŒ HTTP error:', response.status, response.statusText);
                    // Fallback to old method
                    const submissions = await getSubmissions();
                    const approved = submissions.filter(submission => {
                        const status = (submission.status || '').toString().trim().toUpperCase();
                        return submission.approved === true || status === 'APPROVED';
                    });
                    console.log(`âœ… Found ${approved.length} approved bookings (fallback method)`);
                    return approved;
                }
                
                const text = await response.text();
                if (!text || text.trim() === '') {
                    console.error('âŒ Empty response from server');
                    // Fallback to old method
                    const submissions = await getSubmissions();
                    const approved = submissions.filter(submission => {
                        const status = (submission.status || '').toString().trim().toUpperCase();
                        return submission.approved === true || status === 'APPROVED';
                    });
                    console.log(`âœ… Found ${approved.length} approved bookings (fallback method)`);
                    return approved;
                }
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (parseError) {
                    console.error('âŒ Failed to parse JSON:', parseError);
                    // Fallback to old method
                    const submissions = await getSubmissions();
                    const approved = submissions.filter(submission => {
                        const status = (submission.status || '').toString().trim().toUpperCase();
                        return submission.approved === true || status === 'APPROVED';
                    });
                    console.log(`âœ… Found ${approved.length} approved bookings (fallback method)`);
                    return approved;
                }
                
                if (data.success && data.bookings) {
                    console.log(`âœ… Successfully fetched ${data.bookings.length} approved bookings from backend`);
                    return data.bookings;
                } else if (data.error) {
                    console.error('âŒ Apps Script error:', data.error);
                    // Fallback to old method
                    const submissions = await getSubmissions();
                    const approved = submissions.filter(submission => {
                        const status = (submission.status || '').toString().trim().toUpperCase();
                        return submission.approved === true || status === 'APPROVED';
                    });
                    console.log(`âœ… Found ${approved.length} approved bookings (fallback method)`);
                    return approved;
                } else {
                    console.error('âŒ Unexpected response format:', data);
                    // Fallback to old method
                    const submissions = await getSubmissions();
                    const approved = submissions.filter(submission => {
                        const status = (submission.status || '').toString().trim().toUpperCase();
                        return submission.approved === true || status === 'APPROVED';
                    });
                    console.log(`âœ… Found ${approved.length} approved bookings (fallback method)`);
                    return approved;
                }
            } catch (error) {
                console.error('âŒ Error fetching approved bookings:', error);
                // Fallback to old method
                try {
                    const submissions = await getSubmissions();
                    const approved = submissions.filter(submission => {
                        const status = (submission.status || '').toString().trim().toUpperCase();
                        return submission.approved === true || status === 'APPROVED';
                    });
                    console.log(`âœ… Found ${approved.length} approved bookings (fallback method)`);
                    return approved;
                } catch (fallbackError) {
                    console.error('âŒ Fallback also failed:', fallbackError);
                    return [];
                }
            }
        }

        // ============================================
        // POST OPERATIONS HELPER (Form Submission)
        // ============================================
        
        function submitToGoogleSheets(action, data, callback) {
            console.log('ðŸ“¤ submitToGoogleSheets called:', { action, data, url: GOOGLE_SHEETS_URL });
            
            const payload = new URLSearchParams();
            if (action) {
                payload.append('action', action);
                console.log('Form field: action =', action);
            }
            
            if (data && typeof data === 'object') {
                Object.keys(data).forEach(key => {
                    const value = (data[key] !== null && data[key] !== undefined) ? String(data[key]) : '';
                    payload.append(key, value);
                    console.log('Form field:', key, '=', value);
                });
            }
            
            const submitViaFetch = async () => {
                try {
                    const response = await fetch(GOOGLE_SHEETS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                        body: payload.toString(),
                        cache: 'no-store',
                        redirect: 'follow',
                        mode: 'cors'
                    });
                    
                    const text = await response.text();
                    console.log('ðŸ“¬ Google Sheets response:', text);
                    
                    if (!response.ok || (typeof text === 'string' && text.toLowerCase().includes('error'))) {
                        throw new Error(`Google Sheets returned error: ${text}`);
                    }
                    
                    return text;
                } catch (error) {
                    console.warn('âš ï¸ Fetch submit failed, falling back to iframe method:', error);
                    return submitViaIframe();
                }
            };
            
            const submitViaIframe = () => {
                return new Promise((resolve) => {
                    const iframe = document.createElement('iframe');
                    iframe.name = 'hiddenFrame_' + Date.now();
                    iframe.style.display = 'none';
                    iframe.style.width = '0';
                    iframe.style.height = '0';
                    document.body.appendChild(iframe);

                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = GOOGLE_SHEETS_URL;
                    form.target = iframe.name;
                    form.style.display = 'none';

                    // Add all payload entries to the form
                    for (const [key, value] of payload.entries()) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = value;
                        form.appendChild(input);
                    }

                    document.body.appendChild(form);
                    
                    console.log('âœ… Submitting form to:', GOOGLE_SHEETS_URL, '(iframe fallback)');
                    form.submit();

                    // Cleanup after delay
                    setTimeout(() => {
                        try {
                            if (form.parentNode) form.parentNode.removeChild(form);
                            if (iframe.parentNode) iframe.parentNode.removeChild(iframe);
                        } catch (e) {}
                        resolve('iframe-submitted');
                    }, 2000);
                });
            };
            
            const submitPromise = submitViaFetch();
            
            if (callback) {
                submitPromise.then(() => callback()).catch(error => {
                    console.error('âŒ submitToGoogleSheets callback error:', error);
                    callback(error);
                });
            }
            
            return submitPromise;
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function confirmSubmissionRecorded(submissionId, options = {}) {
            const {
                maxAttempts = 8,
                delay = 1500
            } = options;
            
            const normalizedId = (submissionId || '').toString().trim();
            if (!normalizedId) {
                console.warn('âš ï¸ confirmSubmissionRecorded called with empty submissionId');
                return false;
            }
            
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                if (attempt > 1) {
                    await wait(delay);
                }
                
                try {
                    const submissions = await getSubmissions();
                    const found = submissions.some(sub => (sub.id || '').toString().trim() === normalizedId);
                    if (found) {
                        console.log(`âœ… Submission ${normalizedId} confirmed on attempt ${attempt}/${maxAttempts}`);
                        return true;
                    } else {
                        console.log(`âŒ› Submission ${normalizedId} not found yet (attempt ${attempt}/${maxAttempts})`);
                    }
                } catch (error) {
                    console.warn(`âš ï¸ Error checking submissions on attempt ${attempt}/${maxAttempts}:`, error);
                }
            }
            
            console.error(`âŒ Failed to confirm submission ${normalizedId} after ${maxAttempts} attempts`);
            return false;
        }

        // Helper function to normalize date strings to YYYY-MM-DD format (avoids timezone issues)
        function normalizeDate(dateStr) {
            if (!dateStr) return '';
            const str = dateStr.toString().trim();
            
            // If already in YYYY-MM-DD format, return as-is
            if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
                return str;
            }
            
            // Try parsing and reformatting without timezone conversion
            try {
                // Parse date in local timezone by adding time components
                const parts = str.match(/(\d{4})-(\d{2})-(\d{2})/);
                if (parts) {
                    return `${parts[1]}-${parts[2]}-${parts[3]}`;
                }
                
                // Try as Date object but use local methods to avoid UTC conversion
                const date = new Date(str);
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            } catch (e) {
                // Ignore parsing errors
            }
            
            return str;
        }

        async function getTimeSlotsForDate(dateStr, isAdmin = false) {
            const allSlots = await getTimeSlots();
            const normalizedCompareDate = normalizeDate(dateStr);
            
            let slotsForDate = allSlots.filter(slot => {
                if (!slot.date) return false;
                const normalizedSlotDate = normalizeDate(slot.date);
                return normalizedSlotDate === normalizedCompareDate || slot.date === dateStr;
            });
            
            // If not admin, filter out booked slots
            if (!isAdmin) {
                const submissions = await getSubmissions();
                const approvedBookings = await getApprovedBookings();
                
                // Filter out slots with pending submissions for this date
                const pendingForDate = submissions.filter(s => {
                    const status = (s.status || 'PENDING').toString().trim().toUpperCase();
                    const isPending = !s.approved && !s.rejected && status !== 'APPROVED' && status !== 'REJECTED';
                    return isPending && (normalizeDate(s.date) === normalizedCompareDate || s.date === dateStr);
                });
                
                // Filter out slots with approved bookings for this date
                const approvedForDate = approvedBookings.filter(b => 
                    normalizeDate(b.date) === normalizedCompareDate || b.date === dateStr
                );
                
                slotsForDate = slotsForDate.filter(slot => {
                    const slotTime = `${slot.startTime || ''}-${slot.endTime || ''}`.trim();
                    const hasPending = pendingForDate.some(s => {
                        const subTime = `${s.startTime || ''}-${s.endTime || ''}`.trim();
                        return subTime && slotTime && subTime === slotTime;
                    });
                    const hasApproved = approvedForDate.some(b => {
                        const bookTime = `${b.startTime || ''}-${b.endTime || ''}`.trim();
                        return bookTime && slotTime && bookTime === slotTime;
                    });
                    return !hasPending && !hasApproved;
                });
            }
            
            return slotsForDate;
        }

        // Review step update
        function updateReviewStep() {
            document.getElementById('reviewCompany').textContent = document.getElementById('companyName').value;
            document.getElementById('reviewEmail').textContent = document.getElementById('email').value;
            document.getElementById('reviewDateTime').textContent = 
                `${selectedDate} at ${selectedTimeSlot.time}`;
            document.getElementById('reviewWebsite').textContent = document.getElementById('website').value;
            
            // Handle food display
            let foodDisplay = selectedFood;
            if (selectedFood === 'Other' && document.getElementById('otherFoodText').value.trim()) {
                foodDisplay = `Other: ${document.getElementById('otherFoodText').value}`;
            }
            document.getElementById('reviewFood').textContent = foodDisplay;
        }

        // Form submission
        // ============================================
        // POST OPERATIONS (Write Data)
        // ============================================
        
        async function submitForm() {
            if (!selectedDate) {
                alert('Please select a date before submitting.');
                return;
            }
            
            if (!selectedTimeSlot) {
                alert('Please select a time slot before submitting.');
                return;
            }
            
            let foodType = selectedFood;
            if (selectedFood === 'Other' && document.getElementById('otherFoodText').value.trim()) {
                foodType = `Other: ${document.getElementById('otherFoodText').value}`;
            }
            
            const slot = selectedTimeSlot || {};
            const timeSlotId = slot.id || slot.timeSlotId || slot.slotId || '';
            const rawTime = slot.time || '';
            const derivedStart = rawTime.includes(' - ') ? rawTime.split(' - ')[0] : '';
            const derivedEnd = rawTime.includes(' - ') ? rawTime.split(' - ')[1] : '';
            const startTime = slot.startTime || derivedStart;
            const endTime = slot.endTime || derivedEnd;
            
            if (!timeSlotId || !startTime || !endTime) {
                alert('The selected time slot is missing required details. Please select a different slot or try again.');
                return;
            }
            
            const submissionData = {
                submissionId: Date.now().toString(),
                companyName: document.getElementById('companyName').value,
                email: document.getElementById('email').value,
                date: selectedDate,
                timeSlotId: timeSlotId,
                startTime: startTime,
                endTime: endTime,
                website: document.getElementById('website').value,
                foodType: foodType,
                submittedAt: new Date().toISOString()
            };

            showSpaceshipAnimation('Saving your submission to Google Sheets...');

            try {
                await submitToGoogleSheets('submit', submissionData);
                
                const saved = await confirmSubmissionRecorded(submissionData.submissionId);
                hideSpaceshipAnimation();
                
                if (!saved) {
                    alert('We could not confirm that your submission was saved. Please try again in a few seconds.');
                    return;
                }
                
                // Invalidate cached data so future views refetch latest info
                calendarDataCache.loaded = false;
                adminCalendarDataCache.loaded = false;
                
                nextStep();
            } catch (error) {
                console.error('âŒ Failed to submit form:', error);
                hideSpaceshipAnimation();
                alert('Something went wrong while saving your submission. Please check your connection and try again.');
            }
        }

        function resetForm() {
            currentStep = 1;
            selectedDate = null;
            selectedTimeSlot = null;
            selectedFood = null;
            
            // Reset all form fields
            document.getElementById('companyName').value = '';
            document.getElementById('email').value = '';
            document.getElementById('website').value = '';
            document.getElementById('otherFoodText').value = '';
            
            // Reset food selection
            document.querySelectorAll('.food-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.getElementById('otherFoodInput').style.display = 'none';
            
            // Reset button states
            document.getElementById('step1Btn').disabled = true;
            document.getElementById('step2Btn').disabled = true;
            document.getElementById('step3Btn').disabled = true;
            document.getElementById('step4Btn').disabled = true;
            document.getElementById('step5Btn').disabled = true;
            
            // Reset calendar
            currentMonth = 0;
            currentYear = 2026;
            updateCalendar();
            
            // Show step 1
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.getElementById('step1').classList.add('active');
        }

        // Spaceship Animation Functions
        function showSpaceshipAnimation(customMessage) {
            // Create spaceship animation overlay
            const overlay = document.createElement('div');
            overlay.id = 'spaceshipOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;
            
            const spaceship = document.createElement('div');
            spaceship.id = 'spaceship';
            spaceship.innerHTML = 'ðŸš€';
            spaceship.style.cssText = `
                font-size: 80px;
                animation: spaceshipShake 0.5s ease-in-out infinite, spaceshipLiftOff 2s ease-in-out forwards;
                transform-origin: center;
            `;
            
            const message = document.createElement('div');
            message.textContent = customMessage || 'Saving to Google Sheets...';
            message.style.cssText = `
                color: white;
                font-size: 24px;
                margin-top: 20px;
                text-align: center;
                font-family: 'Orbitron', monospace;
            `;
            
            overlay.appendChild(spaceship);
            overlay.appendChild(message);
            document.body.appendChild(overlay);
        }
        
        function hideSpaceshipAnimation() {
            const overlay = document.getElementById('spaceshipOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Debug functions removed - using Google Sheets only

        // Admin Panel Functions
        async function showAdminPanel() {
            const adminPanel = document.getElementById('adminPanel');
            if (!adminPanel.classList.contains('active')) {
                const password = prompt('Password:');
                if (password !== ADMIN_PASSWORD) {
                    alert('Incorrect password.');
                    return;
                }
            }
            
            adminPanel.classList.add('active');
            
            // Show rocket loading animation immediately when admin panel opens (if data not already loaded)
            const wasLoaded = adminCalendarDataCache.loaded;
            if (!wasLoaded) {
                showRocketLoadingAnimation();
            }
            
            await loadAdminData();
            
            // Hide animation after data is loaded (if we showed it)
            if (!wasLoaded) {
                hideRocketLoadingAnimation();
            }
        }

        function hideAdminPanel() {
            document.getElementById('adminPanel').classList.remove('active');
        }

        async function loadAdminData() {
            // Preload admin calendar data if not already loaded
            if (!adminCalendarDataCache.loaded) {
                await preloadAdminCalendarData();
            }
            await loadAdminCalendar();
            await loadSubmissionsList();
        }

        // Admin Calendar Functions
        // Preload admin calendar data once when opening admin panel
        async function preloadAdminCalendarData() {
            // If cache is loaded and has valid data, use it
            if (adminCalendarDataCache.loaded && 
                adminCalendarDataCache.timeSlots != null && 
                adminCalendarDataCache.submissions != null && 
                adminCalendarDataCache.approvedBookings != null) {
                console.log('ðŸ“‹ Admin calendar data already loaded, using cache');
                return;
            }
            
            console.log('ðŸ“¥ Preloading all admin calendar data...');
            try {
                // Fetch all data once
                const timeSlotsPromise = getTimeSlots();
                const submissionsPromise = getSubmissions();
                const approvedBookingsPromise = getApprovedBookings();
                
                [adminCalendarDataCache.timeSlots, adminCalendarDataCache.submissions, adminCalendarDataCache.approvedBookings] = await Promise.all([
                    timeSlotsPromise,
                    submissionsPromise,
                    approvedBookingsPromise
                ]);
                
                console.log(`âœ… Preloaded admin calendar data: ${adminCalendarDataCache.timeSlots.length} time slots, ${adminCalendarDataCache.submissions.length} submissions, ${adminCalendarDataCache.approvedBookings.length} approved bookings`);
                
                // Only mark as loaded if we got valid data
                if (adminCalendarDataCache.timeSlots != null && 
                    adminCalendarDataCache.submissions != null && 
                    adminCalendarDataCache.approvedBookings != null) {
                    adminCalendarDataCache.loaded = true;
                    console.log('âœ… Admin calendar data preloaded successfully');
                } else {
                    console.warn('âš ï¸ Preload completed but some data is null');
                }
            } catch (error) {
                console.error('âŒ Error preloading admin calendar data:', error);
                // Set to empty arrays but mark as loaded to prevent infinite retries
                adminCalendarDataCache.timeSlots = [];
                adminCalendarDataCache.submissions = [];
                adminCalendarDataCache.approvedBookings = [];
                adminCalendarDataCache.loaded = true;
            }
        }

        async function loadAdminCalendar() {
            console.log('Loading admin calendar...');
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];

            document.getElementById('adminCalendarMonth').textContent = 
                `${monthNames[adminCurrentMonth]} ${adminCurrentYear}`;

            const calendarGrid = document.getElementById('adminCalendarGrid');
            calendarGrid.innerHTML = '';
            
            // Preload data if not already loaded (animation is shown in showAdminPanel)
            if (!adminCalendarDataCache.loaded || !adminCalendarDataCache.timeSlots) {
                await preloadAdminCalendarData();
            }

            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });

            // Get first day of month and number of days
            const firstDay = new Date(adminCurrentYear, adminCurrentMonth, 1).getDay();
            const daysInMonth = new Date(adminCurrentYear, adminCurrentMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(adminCurrentYear, adminCurrentMonth, 0).getDate();

            console.log(`Calendar info: firstDay=${firstDay}, daysInMonth=${daysInMonth}, daysInPrevMonth=${daysInPrevMonth}`);

            // Add previous month's trailing days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'admin-calendar-day other-month';
                day.innerHTML = `<div class="admin-day-number">${daysInPrevMonth - i}</div>`;
                calendarGrid.appendChild(day);
            }

            // Use cached data - ensure we have valid data (not null/undefined)
            const timeSlots = (adminCalendarDataCache.timeSlots != null) ? adminCalendarDataCache.timeSlots : [];
            const submissions = (adminCalendarDataCache.submissions != null) ? adminCalendarDataCache.submissions : [];
            const approvedBookings = (adminCalendarDataCache.approvedBookings != null) ? adminCalendarDataCache.approvedBookings : [];
            
            console.log(`ðŸ“† Using cached admin calendar data: ${timeSlots.length} time slots, ${submissions.length} submissions, ${approvedBookings.length} approved bookings`);
            
            // Debug: Log approved bookings to verify they're being loaded
            if (approvedBookings.length > 0) {
                console.log('ðŸ“‹ Approved bookings sample:', approvedBookings.slice(0, 3).map(b => ({
                    id: b.id,
                    company: b.companyName,
                    date: b.date,
                    time: `${b.startTime}-${b.endTime}`
                })));
            } else {
                console.warn('âš ï¸ No approved bookings found in cache!');
            }

            // Add current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'admin-calendar-day';
                
                const dateStr = `${adminCurrentYear}-${String(adminCurrentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Normalize the comparison date
                const normalizedCompareDate = normalizeDate(dateStr);
                
                // Check if this date has time slots - normalize dates for comparison
                // In admin view, show ALL slots regardless of submissionId
                const slotsForDate = timeSlots.filter(slot => {
                    if (!slot.date) {
                        console.log(`Slot ${slot.id} has no date:`, slot);
                        return false;
                    }
                    
                    // Normalize both dates and compare
                    const normalizedSlotDate = normalizeDate(slot.date);
                    
                    // Debug date matching
                    if (normalizedSlotDate === normalizedCompareDate || slot.date === dateStr) {
                        console.log(`âœ… Date match found for ${dateStr}:`, {
                            slotId: slot.id,
                            slotDate: slot.date,
                            normalizedSlotDate: normalizedSlotDate,
                            normalizedCompareDate: normalizedCompareDate,
                            directMatch: slot.date === dateStr
                        });
                    }
                    
                    // Direct string match on normalized dates OR direct date match
                    return normalizedSlotDate === normalizedCompareDate || slot.date === dateStr;
                });
                
                if (slotsForDate.length > 0) {
                    console.log(`âœ… Found ${slotsForDate.length} slots for ${dateStr}:`, slotsForDate);
                } else if (timeSlots.length > 0) {
                    // Debug: show why slots didn't match
                    const nearbySlots = timeSlots.filter(slot => {
                        if (!slot.date) return false;
                        const slotYear = slot.date.substring(0, 4);
                        const slotMonth = slot.date.substring(5, 7);
                        return slotYear === String(adminCurrentYear) && 
                               slotMonth === String(adminCurrentMonth + 1).padStart(2, '0');
                    });
                    if (nearbySlots.length > 0) {
                        console.log(`âš ï¸ No slots for ${dateStr}, but found ${nearbySlots.length} slots in this month:`, nearbySlots.map(s => s.date));
                    }
                }
                
                // Check if this date has pending submissions - normalize dates for comparison
                const pendingSubmissions = submissions.filter(submission => {
                    // Must have a date
                    if (!submission || !submission.date) {
                        return false;
                    }
                    
                    // Check status - exclude only if explicitly APPROVED or REJECTED
                    // Default to PENDING if status is missing/empty
                    const status = (submission.status || 'PENDING').toString().trim().toUpperCase();
                    const isApproved = submission.approved === true || status === 'APPROVED';
                    const isRejected = submission.rejected === true || status === 'REJECTED';
                    
                    if (isApproved || isRejected) {
                        return false;
                    }
                    
                    // Normalize dates and compare with multiple fallback methods
                    const submissionDateStr = submission.date.toString().trim();
                    const normalizedSubmissionDate = normalizeDate(submissionDateStr);
                    const normalizedCompare = normalizeDate(dateStr);
                    
                    // Try multiple matching strategies
                    const matches = 
                        normalizedSubmissionDate === normalizedCompare ||
                        submissionDateStr === dateStr ||
                        submissionDateStr.substring(0, 10) === dateStr.substring(0, 10);
                    
                    if (matches) {
                        console.log('âœ… Found pending submission for', dateStr, ':', {
                            id: submission.id,
                            company: submission.companyName,
                            submissionDate: submissionDateStr,
                            normalized: normalizedSubmissionDate,
                            compareDate: dateStr,
                            normalizedCompare: normalizedCompare,
                            status: status
                        });
                    }
                    
                    return matches;
                });
                
                // Check if this date has approved submissions - normalize dates for comparison
                const approvedSubmissions = approvedBookings.filter(booking => {
                    if (!booking || !booking.date) {
                        return false;
                    }
                    const bookingDateStr = booking.date.toString().trim();
                    const normalizedBookingDate = normalizeDate(bookingDateStr);
                    const normalizedCompare = normalizeDate(dateStr);
                    
                    // Try multiple matching strategies
                    const matches = 
                        normalizedBookingDate === normalizedCompare ||
                        bookingDateStr === dateStr ||
                        bookingDateStr.substring(0, 10) === dateStr.substring(0, 10);
                    
                    return matches;
                });
                
                let slotsHtml = '';
                if (slotsForDate.length > 0) {
                    dayElement.classList.add('has-slots');
                    slotsHtml = '<div class="admin-time-slots">';
                    slotsForDate.forEach(slot => {
                        // Format the time display properly using the formatTimeDisplay function
                        let displayTime = 'N/A';
                        if (slot.startTime && slot.endTime) {
                            const startFormatted = formatTimeDisplay(slot.startTime);
                            const endFormatted = formatTimeDisplay(slot.endTime);
                            displayTime = `${startFormatted} - ${endFormatted}`;
                        } else if (slot.time) {
                            displayTime = formatTimeDisplay(slot.time);
                        }
                        
                        // Check if this slot has an approved booking
                        // Check against ALL approved bookings (not just for this date) to be safe
                        let hasApprovedBooking = false;
                        
                        // Method 1: Check by submissionId (time slot Column F has submission ID)
                        if (slot.submissionId && slot.submissionId.toString().trim() !== '') {
                            const slotSubmissionId = slot.submissionId.toString().trim();
                            hasApprovedBooking = approvedBookings.some(booking => {
                                const bookingId = (booking.id || '').toString().trim();
                                return slotSubmissionId === bookingId;
                            });
                        }
                        
                        // Method 2: Check by timeSlotId (booking has timeSlotId that matches slot.id)
                        if (!hasApprovedBooking) {
                            const slotIdStr = (slot.id || '').toString().trim();
                            hasApprovedBooking = approvedBookings.some(booking => {
                                const bookingTimeSlotId = (booking.timeSlotId || booking.timeSlotIdM || '').toString().trim();
                                return bookingTimeSlotId === slotIdStr;
                            });
                        }
                        
                        // Method 3: Check by date + time matching (for this date only)
                        if (!hasApprovedBooking && approvedSubmissions.length > 0) {
                            const slotTime = `${slot.startTime || ''}-${slot.endTime || ''}`.trim();
                            hasApprovedBooking = approvedSubmissions.some(booking => {
                                const bookTime = `${booking.startTime || ''}-${booking.endTime || ''}`.trim();
                                return bookTime && slotTime && bookTime === slotTime;
                            });
                        }
                        
                        // Mark slot as booked if it has an approved booking
                        const slotClass = hasApprovedBooking ? 'booked-slot' : '';
                        const lockIcon = hasApprovedBooking ? 'ðŸ”’ ' : '';
                        slotsHtml += `<span class="${slotClass}" style="${hasApprovedBooking ? 'color: #4CAF50; font-weight: bold;' : ''}">${lockIcon}${displayTime}</span>`;
                    });
                    slotsHtml += '</div>';
                }
                
                // Add submission info if there are pending submissions - show in YELLOW highlight with time, date, and company name (clickable)
                let submissionHtml = '';
                if (pendingSubmissions.length > 0) {
                    dayElement.classList.add('has-submissions');
                    submissionHtml = '<div class="admin-submission-info" style="background: rgba(255, 255, 0, 0.9); border: 2px solid #ffeb3b; border-radius: 4px; padding: 4px 6px; margin-top: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); position: absolute; top: 2px; left: 2px; right: 2px;">';
                    pendingSubmissions.forEach((submission, index) => {
                        const submissionId = `submission_${dateStr}_${index}_${submission.id}`;
                        
                        // Debug logging
                        console.log('Submission data:', submission);
                        
                        // Get company name and website with fallbacks - check multiple possible property names
                        const companyName = (submission.companyName && submission.companyName.toString().trim()) || 
                                          (submission.company && submission.company.toString().trim()) || 
                                          (submission.name && submission.name.toString().trim()) ||
                                          'Company Name';
                        const website = (submission.website && submission.website.toString().trim()) || '#';
                        
                        // Format the time display
                        const startFormatted = formatTimeDisplay(submission.startTime || '');
                        const endFormatted = formatTimeDisplay(submission.endTime || '');
                        const timeDisplay = (startFormatted !== 'N/A' && endFormatted !== 'N/A') ? `${startFormatted} - ${endFormatted}` : 'Time TBD';
                        
                        // Format the date nicely
                        const dateObj = new Date(dateStr + 'T00:00:00');
                        const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        
                        // Store submission in a way we can access it
                        if (!window.submissionsLookup) {
                            window.submissionsLookup = {};
                        }
                        window.submissionsLookup[submissionId] = submission;
                        
                        submissionHtml += `
                            <div class="admin-submission-item" style="color: #333; font-size: 10px; line-height: 1.3; text-align: center;">
                                <div style="margin-bottom: 1px;">
                                    <strong style="color: #4CAF50; font-size: 11px;">${timeDisplay}</strong>
                                </div>
                                <div style="margin-bottom: 1px; color: #666; font-size: 9px;">
                                    ${formattedDate}
                                </div>
                                <div style="margin-top: 2px;">
                                    <a href="${website}" target="_blank" onclick="event.stopPropagation();" style="color: #333; font-weight: 600; text-decoration: none; border-bottom: 1px solid #333; cursor: pointer; display: inline-block; font-size: 9px;" onmouseover="this.style.color='#1976d2'; this.style.borderBottomColor='#1976d2'" onmouseout="this.style.color='#333'; this.style.borderBottomColor='#333'">${companyName}</a>
                                </div>
                            </div>
                        `;
                    });
                    submissionHtml += '</div>';
                }
                
                // Add approved submission info if there are approved submissions
                let approvedHtml = '';
                if (approvedSubmissions.length > 0) {
                    dayElement.classList.add('has-approved');
                    approvedHtml = '<div class="admin-approved-info">';
                    approvedSubmissions.forEach(submission => {
                        approvedHtml += `<div class="admin-approved-item">ðŸ”’ ${submission.companyName}</div>`;
                    });
                    approvedHtml += '</div>';
                }
                
                dayElement.innerHTML = `
                    <div class="admin-day-number">${day}</div>
                    ${slotsHtml}
                    ${submissionHtml}
                    ${approvedHtml}
                `;
                
                // Add click handler - show submissions if they exist, time slots if they exist, otherwise add time slots
                if (pendingSubmissions.length > 0) {
                    console.log(`Day ${day} has pending submissions, attaching submission handler`);
                    dayElement.onclick = () => showSubmissionDetails(dateStr, pendingSubmissions);
                } else if (approvedSubmissions.length > 0) {
                    console.log(`Day ${day} has approved submissions, attaching approved handler`);
                    dayElement.onclick = () => showApprovedDetails(dateStr, approvedSubmissions);
                } else if (slotsForDate.length > 0) {
                    console.log(`Day ${day} has time slots, attaching review handler for date: ${dateStr}`);
                    dayElement.onclick = () => showTimeSlotsForDate(dateStr, slotsForDate);
                } else {
                    console.log(`Day ${day} is empty, attaching time slot handler for date: ${dateStr}`);
                    dayElement.onclick = () => addTimeSlotToDate(dateStr);
                }
                calendarGrid.appendChild(dayElement);
            }

            // Add next month's leading days
            const totalCells = calendarGrid.children.length;
            const remainingCells = 42 - totalCells; // 6 rows x 7 days = 42 cells
            
            for (let i = 1; i <= remainingCells; i++) {
                const day = document.createElement('div');
                day.className = 'admin-calendar-day other-month';
                day.innerHTML = `<div class="admin-day-number">${i}</div>`;
                calendarGrid.appendChild(day);
            }
            
            console.log('Calendar generation complete - all days should be visible');
        }

        async function changeAdminMonth(direction) {
            adminCurrentMonth += direction;
            if (adminCurrentMonth < 0) {
                adminCurrentMonth = 11;
                adminCurrentYear--;
            } else if (adminCurrentMonth > 11) {
                adminCurrentMonth = 0;
                adminCurrentYear++;
            }
            await loadAdminCalendar();
        }

        // Show submission details for a specific date
        function showSubmissionDetails(dateStr, submissions) {
            // Format date nicely
            const dateObj = new Date(dateStr + 'T00:00:00');
            const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            let detailsHtml = `<div style="margin-bottom: 24px;"><h3 style="color: #333; margin-bottom: 8px;">Pending Submissions</h3><p style="color: #666; font-size: 14px;">${formattedDate}</p></div>`;
            
            // Ensure global lookup exists
            if (!window.submissionsLookup) { window.submissionsLookup = {}; }
            submissions.forEach((submission, index) => {
                // Cache for later lookups (reject/approve flows)
                if (submission && submission.id) {
                    window.submissionsLookup[submission.id] = submission;
                }
                // Format time display properly from submission data
                const displayTime = (submission.startTime && submission.endTime) 
                    ? `${formatTimeDisplay(submission.startTime)} - ${formatTimeDisplay(submission.endTime)}`
                    : (submission.timeSlot?.time || 'N/A');
                const submittedDate = submission.submittedAt ? new Date(submission.submittedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' }) : 'N/A';
                
                detailsHtml += `
                    <div class="submission-detail-item" style="background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="submission-detail-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #ffc107;">
                            <div>
                                <strong style="font-size: 20px; color: #333; display: block; margin-bottom: 4px;">${submission.companyName}</strong>
                                <span style="font-size: 14px; color: #666; display: block; margin-top: 4px;">ðŸ“… ${submittedDate}</span>
                            </div>
                            <div class="submission-actions" style="display: flex; gap: 8px;">
                                <button type="button" class="btn-approve" onclick="approveSubmission('${submission.id}')" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4CAF50'">âœ“ Approve</button>
                                <button type="button" class="btn-reject" onclick="event.stopPropagation(); rejectSubmissionDirect('${submission.id}')" style="background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='#d32f2f'" onmouseout="this.style.background='#f44336'">âœ• Reject</button>
                            </div>
                        </div>
                        <div class="submission-detail-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div>
                                    <span style="color: #666; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Email</span>
                                    <p style="margin: 4px 0 0 0; font-size: 16px; color: #333; font-weight: 500;">${submission.email}</p>
                                </div>
                                <div>
                                    <span style="color: #666; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Time Slot</span>
                                    <p style="margin: 4px 0 0 0; font-size: 16px; color: #333; font-weight: 500;">â° ${displayTime}</p>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div>
                                    <span style="color: #666; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Website</span>
                                    <p style="margin: 4px 0 0 0; font-size: 16px; color: #1976d2;">
                                        <a href="${submission.website}" target="_blank" style="color: #1976d2; text-decoration: none; word-break: break-all;">${submission.website}</a>
                                    </p>
                                </div>
                                <div>
                                    <span style="color: #666; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Food Type</span>
                                    <p style="margin: 4px 0 0 0; font-size: 16px; color: #333; font-weight: 500;">ðŸ½ï¸ ${submission.foodType}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'submission-details-modal';
            modal.innerHTML = `
                <div class="submission-details-content">
                    <div class="submission-details-header">
                        <h2>Submission Details</h2>
                        <button class="close-btn" onclick="closeSubmissionDetails()">Ã—</button>
                    </div>
                    <div class="submission-details-body">
                        ${detailsHtml}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.classList.add('active');
        }

        function closeSubmissionDetails() {
            const modal = document.querySelector('.submission-details-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function editApprovedBooking(bookingId) {
            console.log('âœï¸ EDIT BOOKING:', bookingId);
            
            // Get approved bookings
            const approvedBookings = await getApprovedBookings();
            const booking = approvedBookings.find(b => String(b.id || '').trim() === String(bookingId || '').trim());
            
            if (!booking) {
                alert('Error: Booking not found!');
                return;
            }
            
            console.log('ðŸ“‹ Booking found:', booking);
            
            // Store the booking ID and data for editing
            window.currentEditingBookingId = bookingId;
            window.currentEditingBooking = booking;
            
            // Close the submission details modal
            closeSubmissionDetails();
            
            // Show admin panel if not already visible
            if (!document.getElementById('adminPanel').classList.contains('active')) {
                await showAdminPanel();
            }
            
            // Show a message at the top of the admin calendar indicating edit mode
            showEditModeIndicator(booking);
            
            // Navigate to the booking's date in the calendar
            if (booking.date) {
                const dateObj = new Date(booking.date + 'T00:00:00');
                adminCurrentYear = dateObj.getFullYear();
                adminCurrentMonth = dateObj.getMonth();
                await loadAdminCalendar();
            }
        }
        
        function showEditModeIndicator(booking) {
            // Remove existing indicator if any
            const existingIndicator = document.getElementById('editModeIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Create edit mode indicator
            const indicator = document.createElement('div');
            indicator.id = 'editModeIndicator';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #2196F3 0%, #1976d2 100%);
                color: white;
                padding: 16px 32px;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 16px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 12px;
            `;
            
            const displayTime = (booking.startTime && booking.endTime) 
                ? `${formatTimeDisplay(booking.startTime)} - ${formatTimeDisplay(booking.endTime)}`
                : 'N/A';
            
            indicator.innerHTML = `
                <span>âœï¸ Editing booking for ${booking.companyName}</span>
                <span style="opacity: 0.8;">| Current: ${booking.date} at ${displayTime}</span>
                <button onclick="cancelEditBooking()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-left: 12px;">Cancel</button>
            `;
            
            document.body.appendChild(indicator);
        }
        
        function cancelEditBooking() {
            window.currentEditingBookingId = null;
            window.currentEditingBooking = null;
            const indicator = document.getElementById('editModeIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        async function removeApprovedBooking(bookingId) {
            if (confirm('Are you sure you want to remove this approved booking? This will clear the time slot and remove the booking from Submissions.')) {
                showRocketLoadingAnimation();
                try {
                    const approvedBookings = await getApprovedBookings();
                    console.log('ðŸ” All approved bookings:', approvedBookings);
                    console.log('ðŸ” Looking for booking ID:', bookingId, 'Type:', typeof bookingId);
                    
                    const booking = approvedBookings.find(b => {
                        const idMatch = b.id === bookingId || String(b.id) === String(bookingId);
                        console.log(`Comparing: ${b.id} (${typeof b.id}) === ${bookingId} (${typeof bookingId}): ${idMatch}`);
                        return idMatch;
                    });
                    
                    if (booking) {
                        console.log('âœ… Found booking:', booking);
                        // Get timeSlotId from either timeSlotId or timeSlotIdM (Column M)
                        const timeSlotId = booking.timeSlotId || booking.timeSlotIdM || '';
                        console.log('ðŸ” TimeSlotId:', timeSlotId);
                        
                        // Call backend to clear Column F in TimeSlots and delete from Submissions
                        console.log('ðŸ“¤ Sending to backend:', {
                            submissionId: String(bookingId),
                            timeSlotId: String(timeSlotId || ''),
                            companyName: booking.companyName || '',
                            email: booking.email || '',
                            date: booking.date || ''
                        });
                        
                        submitToGoogleSheets('remove-approved-booking', { 
                            submissionId: String(bookingId),
                            timeSlotId: String(timeSlotId || ''),
                            companyName: booking.companyName || '',
                            email: booking.email || '',
                            date: booking.date || ''
                        }, async () => {
                            // Invalidate caches and reload
                            adminCalendarDataCache.loaded = false;
                            adminCalendarDataCache.timeSlots = null;
                            adminCalendarDataCache.submissions = null;
                            adminCalendarDataCache.approvedBookings = null;
                            
                            calendarDataCache.loaded = false;
                            calendarDataCache.timeSlots = null;
                            calendarDataCache.submissions = null;
                            calendarDataCache.approvedBookings = null;
                            
                            await preloadAdminCalendarData();
                            await preloadCalendarData();
                            
                            closeSubmissionDetails();
                            await loadAdminCalendar();
                            updateCalendar();
                            await loadSubmissionsList();
                            
                            hideRocketLoadingAnimation();
                            alert(`Booking for ${booking.companyName} has been removed. The time slot is now available.`);
                        });
                    } else {
                        hideRocketLoadingAnimation();
                        console.error('âŒ Booking not found in approved bookings list');
                        console.error('Available IDs:', approvedBookings.map(b => ({ id: b.id, type: typeof b.id, company: b.companyName })));
                        alert('Error: Booking not found in approved bookings list. Check console for details.');
                    }
                } catch (error) {
                    hideRocketLoadingAnimation();
                    console.error('Error removing approved booking:', error);
                    alert('Error removing booking. Please try again.');
                }
            }
        }

        // Show approved submission details for a specific date
        function showApprovedDetails(dateStr, submissions) {
            // Format date nicely
            const dateObj = new Date(dateStr + 'T00:00:00');
            const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            let detailsHtml = `<div style="margin-bottom: 24px;"><h3 style="color: #333; margin-bottom: 8px;">Approved Bookings</h3><p style="color: #666; font-size: 14px;">${formattedDate}</p></div>`;
            
            submissions.forEach(submission => {
                // Format time display properly from submission data
                const displayTime = (submission.startTime && submission.endTime) 
                    ? `${formatTimeDisplay(submission.startTime)} - ${formatTimeDisplay(submission.endTime)}`
                    : (submission.timeSlot?.time || 'N/A');
                const submittedDate = submission.submittedAt ? new Date(submission.submittedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' }) : 'N/A';
                const approvedDate = submission.approvedAt ? new Date(submission.approvedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' }) : 'N/A';
                
                detailsHtml += `
                    <div class="submission-detail-item approved" style="background: #e8f5e9; border-left: 4px solid #4CAF50; border-radius: 8px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="submission-detail-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #4CAF50;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <strong style="font-size: 20px; color: #333;">${submission.companyName}</strong>
                                    <span style="background: #4CAF50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">âœ“ APPROVED</span>
                                </div>
                                <span style="font-size: 14px; color: #666; display: block; margin-top: 4px;">ðŸ“… Approved on ${approvedDate}</span>
                            </div>
                            <div class="submission-actions" style="display: flex; gap: 8px;">
                                <button class="btn-edit" onclick="editApprovedBooking('${submission.id}')" style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='#2196F3'">âœï¸ Edit</button>
                                <button class="btn-remove" onclick="removeApprovedBooking('${submission.id}')" style="background: #ff4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='#cc0000'" onmouseout="this.style.background='#ff4444'">ðŸ—‘ï¸ Remove</button>
                            </div>
                        </div>
                        <div class="submission-detail-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div>
                                    <span style="color: #666; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Email</span>
                                    <p style="margin: 4px 0 0 0; font-size: 16px; color: #333; font-weight: 500;">${submission.email}</p>
                                </div>
                                <div>
                                    <span style="color: #666; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Time Slot</span>
                                    <p style="margin: 4px 0 0 0; font-size: 16px; color: #333; font-weight: 500;">â° ${displayTime}</p>
                                </div>
                                <div>
                                    <span style="color: #666; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Submitted</span>
                                    <p style="margin: 4px 0 0 0; font-size: 14px; color: #666;">${submittedDate}</p>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div>
                                    <span style="color: #666; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Website</span>
                                    <p style="margin: 4px 0 0 0; font-size: 16px; color: #1976d2;">
                                        <a href="${submission.website}" target="_blank" style="color: #1976d2; text-decoration: none; word-break: break-all;">${submission.website}</a>
                                    </p>
                                </div>
                                <div>
                                    <span style="color: #666; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Food Type</span>
                                    <p style="margin: 4px 0 0 0; font-size: 16px; color: #333; font-weight: 500;">ðŸ½ï¸ ${submission.foodType}</p>
                                </div>
                                <div>
                                    <span style="color: #666; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Approved</span>
                                    <p style="margin: 4px 0 0 0; font-size: 14px; color: #666;">${approvedDate}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'submission-details-modal';
            modal.innerHTML = `
                <div class="submission-details-content">
                    <div class="submission-details-header">
                        <h2>Approved Bookings</h2>
                        <button class="close-btn" onclick="closeSubmissionDetails()">Ã—</button>
                    </div>
                    <div class="submission-details-body">
                        ${detailsHtml}
                        <div class="add-more-slots-section">
                            <button class="btn-add-more" id="addMoreBtn">Add More Time Slots</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.classList.add('active');
        }

        // Admin Tab Switching
        function switchAdminTab(tabName, event) {
            // Update tab buttons
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: find the button by text content
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    if (tab.textContent.trim() === (tabName === 'calendar' ? 'Calendar Management' : 'Outlook Calendar invite Assistant')) {
                        tab.classList.add('active');
                    }
                });
            }

            // Update tab content
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (tabName === 'calendar') {
                document.getElementById('calendarTab').classList.add('active');
            } else if (tabName === 'outlook') {
                document.getElementById('outlookTab').classList.add('active');
                initializeOutlookReport();
            }
        }

        // Outlook Calendar invite Assistant state
        let outlookReportLoading = false; // Prevent multiple simultaneous loads

        // Initialize Outlook Report
        function initializeOutlookReport() {
            // Load the report (always shows all months)
            loadOutlookReport();
        }

        // Load Outlook Report
        async function loadOutlookReport() {
            // Prevent multiple simultaneous loads
            if (outlookReportLoading) {
                console.log('ðŸ“‹ Outlook Report: Already loading, skipping...');
                return;
            }
            
            outlookReportLoading = true;
            
            const contentDiv = document.getElementById('outlookReportContent');
            
            if (!contentDiv) {
                console.error('Content div not found');
                outlookReportLoading = false;
                return;
            }
            
            contentDiv.innerHTML = '<div class="loading-outlook">Loading approved submissions...</div>';
            
            try {
                const approvedBookings = await getApprovedBookings();
                console.log('ðŸ“‹ Outlook Report: Loaded', approvedBookings.length, 'approved bookings');
                console.log('ðŸ“‹ Showing all months');
                
                if (approvedBookings.length === 0) {
                    contentDiv.innerHTML = `
                        <div class="no-bookings">
                            <span class="no-bookings-icon">ðŸ“­</span>
                            <p>No approved submissions found.</p>
                        </div>
                    `;
                    return;
                }
                
                // Group bookings by month
                const bookingsByMonth = {};
                
                approvedBookings.forEach(booking => {
                    if (!booking || !booking.date) return;
                    
                    let dateStr = booking.date.toString().trim();
                    const normalizedDate = normalizeDate(dateStr);
                    
                    console.log('ðŸ“… Processing booking:', {
                        company: booking.companyName,
                        rawDate: dateStr,
                        normalizedDate: normalizedDate
                    });
                    
                    if (normalizedDate && /^\d{4}-\d{2}-\d{2}$/.test(normalizedDate)) {
                        const [year, month] = normalizedDate.split('-');
                        const monthKey = `${year}-${month}`;
                        
                        if (!bookingsByMonth[monthKey]) {
                            bookingsByMonth[monthKey] = [];
                        }
                        bookingsByMonth[monthKey].push(booking);
                    } else {
                        // Try alternative date parsing
                        try {
                            const date = new Date(dateStr);
                            if (!isNaN(date.getTime())) {
                                const year = date.getFullYear();
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const monthKey = `${year}-${month}`;
                                
                                if (!bookingsByMonth[monthKey]) {
                                    bookingsByMonth[monthKey] = [];
                                }
                                bookingsByMonth[monthKey].push(booking);
                            }
                        } catch (e) {
                            console.warn('Could not parse date:', dateStr, e);
                        }
                    }
                });
                
                console.log('ðŸ“‹ Bookings grouped by month:', Object.keys(bookingsByMonth));
                
                // Always show all months
                const filteredMonths = bookingsByMonth;
                
                // Sort months chronologically
                const sortedMonths = Object.keys(filteredMonths).sort();
                
                console.log('ðŸ“‹ Sorted months to display:', sortedMonths);
                
                if (sortedMonths.length === 0) {
                    contentDiv.innerHTML = `
                        <div class="no-bookings">
                            <span class="no-bookings-icon">ðŸ“…</span>
                            <p>No approved submissions found.</p>
                        </div>
                    `;
                    outlookReportLoading = false;
                    return;
                }
                
                // Render each month
                let html = '';
                sortedMonths.forEach(monthKey => {
                    const bookings = filteredMonths[monthKey];
                    if (!bookings || bookings.length === 0) return;
                    
                    const [year, month] = monthKey.split('-');
                    const monthDate = new Date(parseInt(year), parseInt(month) - 1, 1);
                    const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    
                    // Sort bookings by date and time
                    bookings.sort((a, b) => {
                        const dateA = new Date(a.date + ' ' + (a.startTime || ''));
                        const dateB = new Date(b.date + ' ' + (b.startTime || ''));
                        return dateA - dateB;
                    });
                    
                    html += `
                        <div class="month-section">
                            <div class="month-header">
                                <span>${monthName} (${bookings.length} ${bookings.length === 1 ? 'booking' : 'bookings'})</span>
                                <button class="btn-primary" onclick="generatePosterForMonth('${monthName}')" style="padding: 8px 16px; font-size: 14px; border-radius: 6px; cursor: pointer; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                    ðŸŽ¨ Generate Poster
                                </button>
                            </div>
                            <div class="bookings-grid">
                    `;
                    
                    bookings.forEach(booking => {
                        let date;
                        try {
                            const normalizedDate = normalizeDate(booking.date);
                            if (normalizedDate && /^\d{4}-\d{2}-\d{2}$/.test(normalizedDate)) {
                                const [y, m, d] = normalizedDate.split('-');
                                date = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
                            } else {
                                date = new Date(booking.date);
                            }
                        } catch (e) {
                            date = new Date(booking.date);
                        }
                        
                        if (isNaN(date.getTime())) {
                            date = new Date();
                        }
                        
                        const formattedDate = date.toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            month: 'long', 
                            day: 'numeric',
                            year: 'numeric'
                        });
                        
                        const startTime = formatTimeDisplay(booking.startTime || '');
                        const endTime = formatTimeDisplay(booking.endTime || '');
                        const timeDisplay = (startTime !== 'N/A' && endTime !== 'N/A') ? 
                            `${startTime} - ${endTime}` : 'Time TBD';
                        
                        html += `
                            <div class="booking-card-outlook">
                                <div class="booking-card-header">
                                    <span class="booking-lock-icon">ðŸ”’</span>
                                    <h3 class="booking-company-name">${booking.companyName || 'Unknown Company'}</h3>
                                </div>
                                <div class="booking-details">
                                    <div class="booking-detail-item">
                                        <span class="icon">ðŸ“…</span>
                                        <strong>Date:</strong> ${formattedDate}
                                    </div>
                                    <div class="booking-detail-item">
                                        <span class="icon">ðŸ•</span>
                                        <strong>Time:</strong> ${timeDisplay}
                                    </div>
                                    ${booking.website ? `
                                        <div class="booking-detail-item">
                                            <span class="icon">ðŸŒ</span>
                                            <strong>Website:</strong> <a href="${booking.website}" target="_blank">${booking.website}</a>
                                        </div>
                                    ` : ''}
                                    <div class="booking-detail-item">
                                        <span class="icon">ðŸ½ï¸</span>
                                        <strong>Food:</strong> ${booking.foodType || 'Not specified'}
                                    </div>
                                </div>
                                <div class="booking-actions" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                                    <button class="btn-ai-invitation" onclick="event.stopPropagation(); generateAIInvitation('${booking.id}')" style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s; width: 100%;" onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='#2196F3'">
                                        âœ‰ï¸ Click for AI Invitation
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                contentDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading outlook report:', error);
                contentDiv.innerHTML = `
                    <div class="no-bookings">
                        <span class="no-bookings-icon">âŒ</span>
                        <p>Error loading approved submissions. Please try again.</p>
                    </div>
                `;
            } finally {
                outlookReportLoading = false;
            }
        }
        
        // Poster Generation Functions
        async function generatePosterForMonth(monthName) {
            document.getElementById('posterModal').style.display = 'flex';
            document.getElementById('posterModalTitle').textContent = `ðŸŽ¨ ${monthName} Poster`;
            const previewDiv = document.getElementById('posterPreview');
            const bookingsContainer = document.getElementById('posterBookingsList');
            showPosterLoading('Preparing poster...');
            if (bookingsContainer) bookingsContainer.innerHTML = 'Loading bookings...';
            window.currentPosterBaseImage = null;
            window.currentPosterFinalDataUrl = null;
            window.currentPosterBookings = null;
            window.currentPosterMonthLabel = monthName;
            window.currentPosterUsedFallback = false;
            window.posterAutoComposePending = true;

            const sanitizedMonthLabel = monthName.replace(/\u00A0/g, ' ').trim();
            const monthNameOnly = sanitizedMonthLabel.split(' ')[0];
            const imagePath = `./${monthNameOnly}.png`;

            const posterImage = new Image();
            const dataUrl = typeof getPosterImageData === 'function'
                ? (getPosterImageData(sanitizedMonthLabel) || getPosterImageData(monthNameOnly))
                : null;
            posterImage.onload = function() {
                window.currentPosterBaseImage = posterImage;
                window.currentPosterBaseImageIsSanitized = !!dataUrl;
                window.currentPosterFinalDataUrl = null;
                window.currentPosterSanitizedSource = null;
                window.currentPosterImageSanitizePromise = null;
                maybeComposePoster();
                
                if (!dataUrl) {
                    window.currentPosterImageSanitizePromise = createSafePosterImage(posterImage.src)
                        .then(safeImage => {
                            if (safeImage) {
                                setSanitizedPosterImage(safeImage);
                            }
                            return safeImage;
                        })
                        .catch(error => {
                            console.warn('Could not sanitize poster image for canvas export:', error);
                            return null;
                        })
                        .finally(() => {
                            window.currentPosterImageSanitizePromise = null;
                            maybeComposePoster();
                        });
                }
            };

            posterImage.onerror = function() {
                previewDiv.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <p style="color: #f44336; margin-bottom: 20px; font-size: 18px;">Could not load ${monthNameOnly}.png automatically.</p>
                        <p style="color: #666; margin-bottom: 30px;">Please select the poster image manually below.</p>
                        <input type="file" id="posterImageInput" accept="image/png" style="margin-bottom: 20px; padding: 10px; border: 2px dashed #ddd; border-radius: 8px; width: 100%; max-width: 400px;" />
                        <button class="btn-primary" onclick="loadPosterImageFromFile('${monthNameOnly}')" style="padding: 12px 24px; font-size: 16px; border-radius: 8px; cursor: pointer;">Load Image</button>
                    </div>
                `;
            };
            
            posterImage.src = dataUrl || imagePath;

            try {
                const approvedBookings = await getApprovedBookings();
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

                let targetYear = null;
                let targetMonthIndex = null;
                const parsedDate = new Date(sanitizedMonthLabel);
                if (!isNaN(parsedDate.getTime())) {
                    targetYear = parsedDate.getFullYear();
                    targetMonthIndex = parsedDate.getMonth();
                }

                const monthBookings = approvedBookings.filter(booking => {
                    if (!booking || !booking.date) return false;
                    let dateObj;
                    try {
                        const normalized = normalizeDate(booking.date.toString().trim());
                        if (normalized && /^\d{4}-\d{2}-\d{2}$/.test(normalized)) {
                            const [y, m, d] = normalized.split('-');
                            dateObj = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
                        } else {
                            dateObj = new Date(booking.date);
                        }
                    } catch (err) {
                        dateObj = new Date(booking.date);
                    }
                    if (!dateObj || isNaN(dateObj.getTime())) return false;

                    if (targetYear !== null && targetMonthIndex !== null) {
                        return dateObj.getFullYear() === targetYear && dateObj.getMonth() === targetMonthIndex;
                    }
                    return monthNames[dateObj.getMonth()] === monthNameOnly;
                }).sort((a, b) => {
                    const dateA = new Date(`${a.date} ${a.startTime || ''}`);
                    const dateB = new Date(`${b.date} ${b.startTime || ''}`);
                    return dateA - dateB;
                });

                if (bookingsContainer) {
                    if (monthBookings.length === 0) {
                        bookingsContainer.innerHTML = '<div style="color:#777;">No confirmed bookings for this month.</div>';
                    } else {
                        bookingsContainer.innerHTML = monthBookings.map(booking => {
                            let dateObj;
                            try {
                                const normalized = normalizeDate(booking.date.toString().trim());
                                if (normalized && /^\d{4}-\d{2}-\d{2}$/.test(normalized)) {
                                    const [y, m, d] = normalized.split('-');
                                    dateObj = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
                                } else {
                                    dateObj = new Date(booking.date);
                                }
                            } catch (err) {
                                dateObj = new Date(booking.date);
                            }
                            if (!dateObj || isNaN(dateObj.getTime())) dateObj = new Date();

                            const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                            const startTime = formatTimeDisplay(booking.startTime || '');
                            const timeLabel = startTime && startTime !== 'N/A' ? `Starts at ${startTime}` : 'Time TBD';

                            return `
                                <div class="poster-booking-item">
                                    <strong>${booking.companyName || 'Unknown Company'}</strong>
                                    <span>${formattedDate}</span>
                                    <span>${timeLabel}</span>
                                </div>
                            `;
                        }).join('');
                    }
                }
                window.currentPosterBookings = monthBookings;
                window.currentPosterMonthLabel = sanitizedMonthLabel || monthName;
                maybeComposePoster();
            } catch (error) {
                    console.error('Error loading bookings for poster:', error);
                    if (bookingsContainer) {
                        bookingsContainer.innerHTML = '<div style="color:#f44336;">Error loading bookings.</div>';
                    }
            }

            // Bring the modal into view immediately
            const modal = document.getElementById('posterModal');
            if (modal) {
                setTimeout(() => {
                    modal.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 0);
            }

            setTimeout(() => {
                const modal = document.getElementById('posterModal');
                if (modal) {
                    modal.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 0);
        }

        function composePosterImage(baseImage, bookings, monthLabel) {
            const fallbackWidth = 2048;
            const fallbackHeight = Math.round(fallbackWidth * 1.4142); // poster aspect fallback (~A2)
            const width = baseImage ? (baseImage.naturalWidth || baseImage.width) : fallbackWidth;
            const height = baseImage ? (baseImage.naturalHeight || baseImage.height) : fallbackHeight;

            if (!width || !height) {
                return {
                    dataUrl: null,
                    usedFallback: false,
                    error: 'Unable to determine the poster size. Please reopen the poster generator.'
                };
            }

            const renderCanvas = (includeArtwork = true, imageSource = baseImage) => {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                if (includeArtwork && imageSource) {
                    ctx.drawImage(imageSource, 0, 0, width, height);
                } else {
                    const bgGradient = ctx.createLinearGradient(0, 0, 0, height);
                    bgGradient.addColorStop(0, '#080c1e');
                    bgGradient.addColorStop(0.4, '#10172b');
                    bgGradient.addColorStop(1, '#05060f');
                    ctx.fillStyle = bgGradient;
                    ctx.fillRect(0, 0, width, height);

                    ctx.fillStyle = 'rgba(255, 255, 255, 0.04)';
                    const stars = Math.min(160, Math.round(width * 0.06));
                    for (let i = 0; i < stars; i++) {
                        const starX = Math.random() * width;
                        const starY = Math.random() * height * 0.55;
                        const starSize = Math.random() * Math.max(1.2, width * 0.002);
                        ctx.beginPath();
                        ctx.arc(starX, starY, starSize, 0, Math.PI * 2);
                        ctx.fill();
                    }

                    const overlayHeight = height * 0.22;
                    ctx.fillStyle = 'rgba(12, 16, 36, 0.85)';
                    ctx.fillRect(0, height - overlayHeight, width, overlayHeight);
                }

                drawPosterText(ctx, width, height, bookings, monthLabel);
                return canvas;
            };

            let canvas = renderCanvas(true, baseImage);
            let usedFallback = false;
            let dataUrl;

            try {
                dataUrl = canvas.toDataURL('image/png');
            } catch (error) {
                console.warn('Poster export blocked with artwork. Retrying without background.', error);
                canvas = renderCanvas(false);
                try {
                    dataUrl = canvas.toDataURL('image/png');
                    usedFallback = true;
                } catch (secondaryError) {
                    console.error('Poster export failed even with fallback background.', secondaryError);
                    return {
                        dataUrl: null,
                        usedFallback: false,
                        error: 'Unable to compose poster due to browser security restrictions. Please run this page from a local web server (e.g. using "npx serve .").'
                    };
                }
            }

            return { dataUrl, usedFallback, error: null };
        }

        async function buildPosterImage(forDownload = false) {
            const bookings = Array.isArray(window.currentPosterBookings) ? window.currentPosterBookings : [];
            const monthLabel = window.currentPosterMonthLabel;

            if (!bookings || monthLabel == null) {
                if (forDownload) {
                    alert('Poster data is still loading. Please try again in a moment.');
                }
                return false;
            }

            if (!forDownload && window.currentPosterFinalDataUrl) {
                updatePosterUI(window.currentPosterFinalDataUrl, !!window.currentPosterUsedFallback, monthLabel);
                return true;
            }

            if (!bookings.length) {
                if (forDownload) {
                    alert('No confirmed bookings available for this poster.');
                } else {
                    showPosterLoading('No confirmed bookings for this poster.');
                }
                return false;
            }

            if (!window.currentPosterBaseImage) {
                if (forDownload) {
                    alert('Poster image is still loading. Please try again in a moment.');
                }
                return false;
            }

            if (window.currentPosterImageSanitizePromise) {
                try {
                    await window.currentPosterImageSanitizePromise;
                } catch (e) {
                    console.warn('Poster sanitize promise rejected:', e);
                }
            }

            const result = composePosterImage(window.currentPosterBaseImage, bookings, monthLabel);
            if (!result.dataUrl) {
                if (forDownload) {
                    alert(result.error || 'Unable to compose poster due to browser security restrictions. Please run this page from a local web server (e.g. using "npx serve .").');
                } else {
                    showPosterLoading('Unable to compose poster. Try again in a moment.');
                }
                return false;
            }

            window.currentPosterFinalDataUrl = result.dataUrl;
            window.currentPosterUsedFallback = result.usedFallback;

            updatePosterUI(result.dataUrl, result.usedFallback, monthLabel);

            return true;
        }

        async function confirmPoster() {
            if (!window.currentPosterFinalDataUrl) {
                const success = await buildPosterImage(true);
                if (!success) return;
            }

            triggerPosterDownload(window.currentPosterFinalDataUrl, window.currentPosterMonthLabel);
            console.log(`âœ… Poster confirmed with ${window.currentPosterBookings ? window.currentPosterBookings.length : 0} booking(s). Fallback background used: ${window.currentPosterUsedFallback ? 'Yes' : 'No'}`);
        }

        function drawPosterText(ctx, width, height, bookings, monthLabel) {
            // Calculate maximum text width with padding (leave 10% margin on each side)
            const maxTextWidth = width * 0.8;
            const baseFontSize = Math.max(height * 0.036, width * 0.028);
            const subFontSize = baseFontSize * 0.55;
            const lineGap = subFontSize * 0.35;
            const topPadding = height / 3;
            const bottomPadding = height / 22;

            const lowerZoneTop = topPadding;
            const lowerZoneBottom = height - bottomPadding;
            const availableHeight = Math.max(lowerZoneBottom - lowerZoneTop, subFontSize * 2);
            const blockHeight = baseFontSize + lineGap + subFontSize;
            const totalBlockHeight = blockHeight * bookings.length;
            let spacing = (availableHeight - totalBlockHeight) / (bookings.length + 1);
            let startY;

            if (spacing >= 0) {
                startY = lowerZoneTop + spacing;
            } else {
                spacing = 0;
                startY = lowerZoneTop + (availableHeight - totalBlockHeight) / 2;
                startY = Math.max(startY, lowerZoneTop);
                const maxStart = lowerZoneBottom - totalBlockHeight;
                if (startY > maxStart) {
                    startY = maxStart;
                }
            }

            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillStyle = '#CECDC1';
            ctx.shadowColor = 'rgba(0, 0, 0, 0.7)';
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;

            const centerX = width / 2;

            // Helper function to get font size that fits within maxWidth
            function getFittingFontSize(text, initialFontSize, maxWidth) {
                let fontSize = initialFontSize;
                ctx.font = `700 ${Math.round(fontSize)}px "Arial Black", "Arial", sans-serif`;
                let textWidth = ctx.measureText(text).width;
                
                // Reduce font size until text fits
                while (textWidth > maxWidth && fontSize > 10) {
                    fontSize = fontSize * 0.9; // Reduce by 10%
                    ctx.font = `700 ${Math.round(fontSize)}px "Arial Black", "Arial", sans-serif`;
                    textWidth = ctx.measureText(text).width;
                }
                
                return Math.max(fontSize, 10); // Minimum font size of 10px
            }

            let cursorY = startY;

            bookings.forEach((booking, index) => {
                const { heading, subheading } = buildPosterLines(booking, monthLabel);

                // Calculate fitting font size for heading
                const headingFontSize = getFittingFontSize(heading, baseFontSize, maxTextWidth);
                ctx.font = `700 ${Math.round(headingFontSize)}px "Arial Black", "Arial", sans-serif`;
                ctx.shadowBlur = 0;
                ctx.lineWidth = 0;
                ctx.fillText(heading, centerX, cursorY);

                cursorY += headingFontSize + lineGap;

                // Calculate fitting font size for subheading (relative to heading size)
                const subheadingFontSize = getFittingFontSize(subheading, headingFontSize * 0.55, maxTextWidth);
                ctx.font = `700 ${Math.round(subheadingFontSize)}px "Arial Black", "Arial", sans-serif`;
                ctx.shadowBlur = 0;
                ctx.lineWidth = 0;
                ctx.fillText(subheading, centerX, cursorY);

                cursorY += subheadingFontSize;
                if (index !== bookings.length - 1) {
                    cursorY += spacing;
                } else if (spacing > 0) {
                    cursorY += spacing;
                }
            });
        }

        function setSanitizedPosterImage(image) {
            if (!image) return;
            window.currentPosterBaseImage = image;
            window.currentPosterBaseImageIsSanitized = true;
            window.currentPosterSanitizedSource = image.src;
            window.currentPosterFinalDataUrl = null;
            maybeComposePoster();
        }

        function renderPosterPreviewFromSrc(src) {
            const previewDiv = document.getElementById('posterPreview');
            if (!previewDiv || !src) return;

            previewDiv.innerHTML = '';

            const wrapper = document.createElement('div');
            wrapper.style.maxWidth = '80%';
            wrapper.style.maxHeight = '70vh';
            wrapper.style.margin = '0 auto';
            wrapper.style.display = 'flex';
            wrapper.style.justifyContent = 'center';
            wrapper.style.alignItems = 'center';

            const imgEl = document.createElement('img');
            imgEl.src = src;
            imgEl.alt = 'Poster Preview';
            imgEl.style.maxWidth = '100%';
            imgEl.style.maxHeight = '70vh';
            imgEl.style.width = 'auto';
            imgEl.style.height = 'auto';
            imgEl.style.boxShadow = '0 12px 35px rgba(0,0,0,0.25)';
            imgEl.style.borderRadius = '12px';

            wrapper.appendChild(imgEl);
            previewDiv.appendChild(wrapper);
        }

        function showPosterLoading(message) {
            const previewDiv = document.getElementById('posterPreview');
            if (!previewDiv) return;

            previewDiv.innerHTML = `
                <div style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px; color:#ddd; gap:16px;">
                    <div style="width:48px; height:48px; border:5px solid rgba(255,255,255,0.2); border-top-color:#ffffff; border-radius:50%; animation: posterSpinner 1s linear infinite;"></div>
                    <p style="margin:0; font-size:18px; text-align:center;">${message || 'Preparing poster...'}</p>
                </div>
            `;
        }

        async function maybeComposePoster() {
            if (!window.posterAutoComposePending) return;
            if (!window.currentPosterBaseImage) return;
            if (!Array.isArray(window.currentPosterBookings)) return;
            if (window.currentPosterMonthLabel == null) return;

            window.posterAutoComposePending = false;
            try {
                await buildPosterImage(false);
            } catch (error) {
                console.error('Error composing poster:', error);
            }
        }

        function updatePosterUI(dataUrl, usedFallback, monthLabel) {
            if (!dataUrl) return;
            renderPosterPreviewFromSrc(dataUrl);

            const previewDiv = document.getElementById('posterPreview');
            if (previewDiv) {
                const existingNote = previewDiv.querySelector('.poster-fallback-note');
                if (existingNote) {
                    existingNote.remove();
                }
                if (usedFallback) {
                    const note = document.createElement('p');
                    note.className = 'poster-fallback-note';
                    note.textContent = 'Note: Download uses a fallback background because the original poster image is blocked by browser security settings.';
                    note.style.marginTop = '16px';
                    note.style.color = '#f0b429';
                    note.style.fontSize = '14px';
                    note.style.fontWeight = '600';
                    note.style.textShadow = '0 1px 2px rgba(0,0,0,0.35)';
                    note.style.textAlign = 'center';
                    previewDiv.appendChild(note);
                }
            }

            const header = document.querySelector('#posterModal .poster-details-header');
            if (header) {
                let downloadBtn = document.getElementById('posterDownloadButton');
                if (!downloadBtn) {
                    downloadBtn = document.createElement('button');
                    downloadBtn.id = 'posterDownloadButton';
                    downloadBtn.className = 'btn-primary';
                    downloadBtn.style.marginLeft = '8px';
                    downloadBtn.textContent = 'Download Poster';
                    header.appendChild(downloadBtn);
                }
                downloadBtn.onclick = () => {
                    if (!window.currentPosterFinalDataUrl) return;
                    triggerPosterDownload(window.currentPosterFinalDataUrl, window.currentPosterMonthLabel);
                };
            }

            const titleEl = document.getElementById('posterModalTitle');
            if (titleEl) {
                titleEl.textContent = usedFallback ? 'ðŸŽ¨ Poster Ready (Fallback Background)' : 'ðŸŽ¨ Poster Ready';
            }
        }

        function buildPosterLines(booking, fallbackMonthLabel) {
            const dateObj = parsePosterDate(booking);
            let dateLabel;

            if (dateObj) {
                const monthName = dateObj.toLocaleString('en-US', { month: 'long' }).toUpperCase();
                const day = dateObj.getDate();
                const ordinal = getOrdinalSuffix(day).toUpperCase();
                dateLabel = `${monthName} ${day}${ordinal}`;
            } else if (fallbackMonthLabel) {
                dateLabel = fallbackMonthLabel.toUpperCase();
            } else if (booking && booking.date) {
                dateLabel = booking.date.toString().toUpperCase();
            } else {
                dateLabel = 'UPCOMING';
            }

            const companyName = booking && booking.companyName ? booking.companyName.toUpperCase() : 'TBD';
            const heading = `${dateLabel} SCREENING OF ${companyName}`;

            let rawStartTime = booking && booking.startTime ? booking.startTime : '';
            if (!rawStartTime && booking && booking.time) {
                rawStartTime = booking.time;
            }
            if (!rawStartTime && booking && booking.timeSlot) {
                rawStartTime = booking.timeSlot.startTime || booking.timeSlot.time || '';
                if (rawStartTime.includes('-')) {
                    rawStartTime = rawStartTime.split('-')[0];
                }
            }

            const formattedTime = formatTimeDisplay(rawStartTime);
            const upperTime = formattedTime && formattedTime !== 'N/A' ? formattedTime.toUpperCase() : null;
            const subheading = upperTime
                ? `STARTS AT ${upperTime}`
                : 'STARTS AT TBD';

            return { heading, subheading };
        }

        function parsePosterDate(booking) {
            if (!booking) return null;

            const rawDate = booking.date || (booking.timeSlot && booking.timeSlot.date);
            if (!rawDate) return null;

            try {
                const normalized = normalizeDate(rawDate.toString().trim());
                if (normalized && /^\d{4}-\d{2}-\d{2}$/.test(normalized)) {
                    const [year, month, day] = normalized.split('-').map(part => parseInt(part, 10));
                    return new Date(year, month - 1, day);
                }

                const parsedDate = new Date(rawDate);
                if (!isNaN(parsedDate.getTime())) {
                    return parsedDate;
                }
            } catch (error) {
                console.warn('Unable to parse poster date:', rawDate, error);
            }

            return null;
        }
        
        function triggerPosterDownload(dataUrl, monthLabel) {
            if (!dataUrl) return;
            
            const safeLabel = (monthLabel || 'poster').replace(/\s+/g, '_').toLowerCase();
            const timestamp = new Date().toISOString().replace(/[:.-]/g, '').slice(0, 15);
            const filename = `${safeLabel}_screenings_${timestamp}.png`;
            
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function createSafePosterImage(src) {
            try {
                if (!src || src.startsWith('data:')) {
                    return null;
                }

                const protocol = window.location.protocol;
                if (protocol !== 'http:' && protocol !== 'https:') {
                    return null;
                }

                const absoluteSrc = new URL(src, window.location.href).href;
                const response = await fetch(absoluteSrc, { mode: 'cors', cache: 'no-store' });
                if (!response.ok) {
                    console.warn('Poster image fetch returned non-OK status:', response.status);
                    return null;
                }

                const blob = await response.blob();
                const dataUrl = await blobToDataUrl(blob);
                const sanitizedImage = await loadImageFromDataUrl(dataUrl);
                return sanitizedImage;
            } catch (error) {
                console.warn('createSafePosterImage failed:', error);
                return null;
            }
        }

        function blobToDataUrl(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function loadImageFromDataUrl(dataUrl) {
            return new Promise((resolve, reject) => {
                const image = new Image();
                image.crossOrigin = 'anonymous';
                image.onload = () => resolve(image);
                image.onerror = reject;
                image.src = dataUrl;
            });
        }
        
        function closePosterModal() {
            document.getElementById('posterModal').style.display = 'none';
            document.getElementById('posterPreview').innerHTML = '';
        }


        async function addTimeSlotToDate(dateStr) {
            console.log('addTimeSlotToDate called with date:', dateStr);
            
            // Show rocket loading animation
            showRocketLoadingAnimation();
            
            // Wait a moment for animation, then show modal
            setTimeout(async () => {
                await showTimePickerModal(dateStr);
                hideRocketLoadingAnimation();
            }, 1500); // 1.5 seconds for shake + lift off
        }

        // Rocket Loading Animation Functions
        function showRocketLoadingAnimation() {
            // Create rocket loading overlay
            const overlay = document.createElement('div');
            overlay.id = 'rocketLoadingOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                backdrop-filter: blur(3px);
            `;
            
            // Rocket container
            const rocketContainer = document.createElement('div');
            rocketContainer.style.cssText = `
                position: relative;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            `;
            
            // Fire emoji (behind rocket)
            const fire = document.createElement('div');
            fire.id = 'rocketFire';
            fire.innerHTML = 'ðŸ”¥';
            fire.style.cssText = `
                font-size: 40px;
                position: absolute;
                bottom: -20px;
                animation: fireFadeIn 0.3s ease-in-out infinite;
                opacity: 0;
                transform: scale(0.8);
            `;
            
            // Rocket emoji
            const rocket = document.createElement('div');
            rocket.id = 'rocket';
            rocket.innerHTML = 'ðŸš€';
            rocket.style.cssText = `
                font-size: 80px;
                position: relative;
                animation: rocketShake 1s ease-in-out infinite;
                z-index: 2;
            `;
            
            // Message
            const message = document.createElement('div');
            message.textContent = 'hold up a sec';
            message.style.cssText = `
                color: white;
                font-size: 24px;
                margin-top: 30px;
                text-align: center;
                font-family: 'Orbitron', monospace;
                font-weight: 600;
                letter-spacing: 2px;
            `;
            
            // After 1 second of shaking, start lift off animation
            setTimeout(() => {
                rocket.style.animation = 'rocketShake 1s ease-in-out, rocketLiftOff 1s ease-out forwards';
                fire.style.animation = 'fireFadeIn 0.3s ease-in-out infinite';
                fire.style.opacity = '1';
            }, 1000);
            
            rocketContainer.appendChild(fire);
            rocketContainer.appendChild(rocket);
            overlay.appendChild(rocketContainer);
            overlay.appendChild(message);
            document.body.appendChild(overlay);
        }

        function hideRocketLoadingAnimation() {
            const overlay = document.getElementById('rocketLoadingOverlay');
            if (overlay) {
                overlay.style.transition = 'opacity 0.3s ease-out';
                overlay.style.opacity = '0';
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                }, 300);
            }
        }

        // Helper function to format time display from various formats
        function formatTimeDisplay(timeStr) {
            if (!timeStr) return 'N/A';
            
            // If it's already in a nice format like "3:00 PM", return as-is
            if (typeof timeStr === 'string' && /^\d{1,2}:\d{2}\s*(AM|PM)/i.test(timeStr.trim())) {
                return timeStr.trim();
            }
            
            // If it's an ISO date string, parse it and format
            try {
                const date = new Date(timeStr);
                if (!isNaN(date.getTime())) {
                    // Extract just the time part
                    return date.toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                }
            } catch (e) {
                // If parsing fails, try to extract time from string
                const timeMatch = timeStr.toString().match(/(\d{1,2}):(\d{2})/);
                if (timeMatch) {
                    let hours = parseInt(timeMatch[1]);
                    const minutes = timeMatch[2];
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    if (hours > 12) hours -= 12;
                    if (hours === 0) hours = 12;
                    return `${hours}:${minutes} ${ampm}`;
                }
            }
            
            return timeStr.toString();
        }

        async function showTimeSlotsForDate(dateStr, timeSlots) {
            console.log('showTimeSlotsForDate called with date:', dateStr, 'slots:', timeSlots);
            
            // Format date nicely
            const dateObj = new Date(dateStr + 'T00:00:00');
            const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Check if in edit mode
            const isEditMode = window.currentEditingBookingId != null;
            const editModeTitle = isEditMode ? 'Select New Time Slot' : 'Time Slots';
            
            // Create modal HTML
            let modalHtml = `
                <div class="submission-details-modal active">
                    <div class="submission-details-content">
                        <div class="submission-details-header">
                            <h2>${editModeTitle} - ${formattedDate}</h2>
                            <button class="close-btn" onclick="closeSubmissionDetails()">Ã—</button>
                        </div>
                        <div class="submission-details-body">
                            ${timeSlots.length === 0 ? '<p style="text-align: center; color: #666; padding: 20px;">No time slots available for this date.</p>' : ''}
                            <div class="time-slots-list" style="display: grid; gap: 12px; margin-bottom: 20px;">
            `;
            
            timeSlots.forEach((slot, index) => {
                // Format the time display properly
                let displayTime = 'N/A';
                if (slot.startTime && slot.endTime) {
                    const startFormatted = formatTimeDisplay(slot.startTime);
                    const endFormatted = formatTimeDisplay(slot.endTime);
                    displayTime = `${startFormatted} - ${endFormatted}`;
                } else if (slot.time) {
                    displayTime = formatTimeDisplay(slot.time);
                }
                
                const hasSubmission = slot.submissionId && slot.submissionId.toString().trim() !== '';
                const isEditMode = window.currentEditingBookingId != null;
                
                // Show "Select" button if in edit mode and slot is available, otherwise show "Remove" button
                let actionButton = '';
                if (isEditMode && !hasSubmission) {
                    // In edit mode, show "Select" button for available slots
                    actionButton = `<button class="select-time-slot-btn" onclick="selectTimeSlotForBooking('${slot.id}', '${dateStr}', '${slot.startTime || ''}', '${slot.endTime || ''}')" style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='#2196F3'">âœ“ Select</button>`;
                } else if (!isEditMode) {
                    // Not in edit mode, show "Remove" button
                    actionButton = `<button class="remove-time-slot-btn" onclick="deleteTimeSlot('${slot.id}')" style="background: #ff4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='#cc0000'" onmouseout="this.style.background='#ff4444'">Remove</button>`;
                }
                
                modalHtml += `
                    <div class="time-slot-item" data-id="${slot.id}" style="background: ${hasSubmission ? '#f0f8f0' : '#f9f9f9'}; border: 1px solid ${hasSubmission ? '#4CAF50' : '#ddd'}; border-radius: 8px; padding: 16px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;">
                        <div class="time-slot-info" style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 18px; font-weight: 600; color: #333;">${displayTime}</span>
                                ${hasSubmission ? '<span style="background: #4CAF50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">BOOKED</span>' : '<span style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">AVAILABLE</span>'}
                            </div>
                        </div>
                        ${actionButton}
                    </div>
                `;
            });
            
            modalHtml += `
                            </div>
                            ${!isEditMode ? `<div style="margin-top: 20px; text-align: center; padding-top: 20px; border-top: 2px solid #eee;">
                                <button class="btn" onclick="closeSubmissionDetails(); addTimeSlotToDate('${dateStr}');" style="background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4CAF50'">âž• Add More Time Slots</button>
                            </div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.querySelector('.submission-details-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        async function selectTimeSlotForBooking(timeSlotId, newDate, startTime, endTime) {
            if (!window.currentEditingBookingId || !window.currentEditingBooking) {
                alert('Error: No booking selected for editing!');
                return;
            }
            
            const booking = window.currentEditingBooking;
            const bookingId = window.currentEditingBookingId;
            
            console.log('âœ… SELECTING TIME SLOT FOR BOOKING:', {
                bookingId,
                timeSlotId,
                newDate,
                startTime,
                endTime,
                oldDate: booking.date,
                oldStartTime: booking.startTime,
                oldEndTime: booking.endTime
            });
            
            // Confirm the change
            const confirmMessage = `Change booking for ${booking.companyName}?\n\nFrom: ${booking.date} at ${formatTimeDisplay(booking.startTime)} - ${formatTimeDisplay(booking.endTime)}\nTo: ${newDate} at ${formatTimeDisplay(startTime)} - ${formatTimeDisplay(endTime)}`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Close the modal
            closeSubmissionDetails();
            
            // Show loading animation
            showRocketLoadingAnimation();
            
            // Update the booking - we'll need to create a backend action for this
            // For now, we'll update it by modifying the Accepted sheet directly
            // This requires a new backend action: 'update-approved'
            
            const updateData = {
                submissionId: bookingId,
                newDate: newDate,
                newStartTime: startTime,
                newEndTime: endTime,
                newTimeSlotId: timeSlotId,
                oldTimeSlotId: booking.timeSlotId || ''
            };
            
            console.log('ðŸ“¤ Sending update request:', updateData);
            
            // Submit update request
            submitToGoogleSheets('update-approved', updateData, async () => {
                console.log('âœ… Update request sent');
                
                // Wait a moment for backend to process
                setTimeout(async () => {
                    try {
                        // Refresh caches - clear everything first
                        adminCalendarDataCache.loaded = false;
                        adminCalendarDataCache.timeSlots = null;
                        adminCalendarDataCache.submissions = null;
                        adminCalendarDataCache.approvedBookings = null;
                        
                        calendarDataCache.loaded = false;
                        calendarDataCache.timeSlots = null;
                        calendarDataCache.submissions = null;
                        calendarDataCache.approvedBookings = null;
                        
                        console.log('ðŸ”„ Reloading all data after update...');
                        
                        // Reload data - ensure these complete successfully
                        await preloadAdminCalendarData();
                        console.log('âœ… Admin calendar data reloaded');
                        
                        await preloadCalendarData();
                        console.log('âœ… User calendar data reloaded');
                        
                        // Reload submissions list
                        await loadSubmissionsList();
                        console.log('âœ… Submissions list reloaded');
                        
                        // Reload calendars
                        await loadAdminCalendar();
                        console.log('âœ… Admin calendar reloaded');
                        
                        await updateCalendar();
                        console.log('âœ… User calendar updated');
                        
                        // Exit edit mode
                        cancelEditBooking();
                        
                        // Hide loading animation
                        hideRocketLoadingAnimation();
                        
                        alert(`âœ… Booking updated successfully!\n\n${booking.companyName} has been moved to ${newDate} at ${formatTimeDisplay(startTime)} - ${formatTimeDisplay(endTime)}`);
                    } catch (error) {
                        console.error('âŒ Error reloading after update:', error);
                        hideRocketLoadingAnimation();
                        alert('Booking was updated, but there was an error refreshing the calendar. Please refresh the page.');
                    }
                }, 2000);
            });
        }

        async function deleteTimeSlot(slotId) {
            console.log('deleteTimeSlot called with ID:', slotId, 'Type:', typeof slotId);
            
            // Show custom confirmation modal
            showConfirmModal(
                'Delete Time Slot',
                'Are you sure you want to remove this time slot? This action cannot be undone.',
                async () => {
                    // Close both modals immediately when confirmed
                    closeConfirmModal();
                    closeSubmissionDetails();
                    
                    // User confirmed deletion - do the deletion in background
                    showRocketLoadingAnimation();
                    console.log('ðŸ—‘ï¸ Deleting time slot with ID:', slotId, 'Type:', typeof slotId);
                    
                    // Ensure slotId is a string and properly encoded
                    const cleanId = String(slotId).trim();
                    console.log('ðŸ” Clean ID being sent:', cleanId);
                    
                    submitToGoogleSheets('delete', { id: cleanId }, async () => {
                        // Wait a moment for deletion, then refresh calendars
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        try {
                            // Invalidate caches
                            adminCalendarDataCache.loaded = false;
                            adminCalendarDataCache.timeSlots = null;
                            calendarDataCache.loaded = false;
                            calendarDataCache.timeSlots = null;
                            
                            await preloadAdminCalendarData();
                            await preloadCalendarData();
                            
                            await loadAdminCalendar();
                            await updateCalendar();
                            
                            hideRocketLoadingAnimation();
                            console.log('âœ… Time slot deletion completed');
                        } catch (error) {
                            hideRocketLoadingAnimation();
                            console.error('âŒ Error refreshing calendar:', error);
                            alert('Time slot may have been deleted, but there was an error refreshing the calendar. Please refresh the page.');
                        }
                    });
                }
            );
        }

        function showConfirmModal(title, message, onConfirm) {
            // Remove existing modal if any
            const existingModal = document.querySelector('.confirm-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML
            const modalHtml = `
                <div class="confirm-modal active">
                    <div class="confirm-modal-content">
                        <h3>${title}</h3>
                        <p>${message}</p>
                        <div class="confirm-modal-buttons">
                            <button class="confirm-btn cancel" onclick="closeConfirmModal()">Cancel</button>
                            <button class="confirm-btn delete" onclick="confirmAction()">Delete</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Store the confirm callback
            window._confirmCallback = onConfirm;
        }

        function confirmAction() {
            if (window._confirmCallback) {
                window._confirmCallback();
                window._confirmCallback = null;
            }
        }

        function closeConfirmModal() {
            const modal = document.querySelector('.confirm-modal');
            if (modal) {
                modal.remove();
            }
            window._confirmCallback = null;
        }

        function showSuccessModal(message, isError = false) {
            // Remove existing modal if any
            const existingModal = document.querySelector('.success-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML
            const modalHtml = `
                <div class="success-modal active">
                    <div class="success-modal-content">
                        <h3 class="${isError ? 'error' : ''}">${isError ? 'âŒ Error' : 'âœ… Success'}</h3>
                        <p>${message}</p>
                        <button onclick="closeSuccessModal()">OK</button>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Auto-close after 3 seconds if not error
            if (!isError) {
                setTimeout(() => {
                    closeSuccessModal();
                }, 3000);
            }
        }

        function closeSuccessModal() {
            const modal = document.querySelector('.success-modal');
            if (modal) {
                modal.remove();
            }
        }

        function addMoreTimeSlots(dateStr) {
            console.log('addMoreTimeSlots called with date:', dateStr);
            // Close the approved details modal
            closeSubmissionDetails();
            // Clear any editing state
            window.currentEditingBookingId = null;
            console.log('Cleared editing state, calling showTimePickerModal');
            // Open the time picker modal
            showTimePickerModal(dateStr);
        }

        // Time Picker Modal Functions
        let currentEditingDate = null;

        // Clock state
        let startTime = { hour: 10, ampm: 'AM' };
        let endTime = { hour: 11, ampm: 'AM' };
        
        // Drag state
        let isDragging = false;
        let dragClockType = null;

        async function showTimePickerModal(dateStr) {
            console.log('showTimePickerModal called with date:', dateStr);
            
            try {
                currentEditingDate = dateStr;
                
                // Check if the modal elements exist
                const dateElement = document.getElementById('timePickerDate');
                const modalElement = document.getElementById('timePickerModal');
                
                if (!dateElement) {
                    console.error('timePickerDate element not found');
                    return;
                }
                if (!modalElement) {
                    console.error('timePickerModal element not found');
                    return;
                }
                
                dateElement.textContent = dateStr;
                console.log('Date element updated');
                
                // Update modal title and button text based on whether we're editing or adding
                const modalTitle = document.querySelector('#timePickerModal h3');
                const addButton = document.querySelector('#timePickerModal .time-picker-btn.primary');
                
                if (modalTitle && addButton) {
                    if (window.currentEditingBookingId) {
                        modalTitle.textContent = 'Edit Booking Time';
                        addButton.textContent = 'Update Booking';
                    } else {
                        modalTitle.textContent = 'Add Time Slot';
                        addButton.textContent = 'Add Time';
                    }
                    console.log('Modal title and button updated');
                } else {
                    console.error('Modal title or button not found');
                }
                
                await loadTimePickerSlots(dateStr);
                modalElement.classList.add('active');
                console.log('Time picker modal should now be visible');
                initializeClocks();
                
            } catch (error) {
                console.error('Error in showTimePickerModal:', error);
                alert('Error opening time picker: ' + error.message);
            }
        }

        function initializeClocks() {
            // Use initial times if editing, otherwise reset to default
            if (window.currentEditingBookingId && window.initialStartHour !== undefined) {
                const startHour = window.initialStartHour;
                const endHour = window.initialEndHour;
                
                startTime = {
                    hour: startHour > 12 ? startHour - 12 : (startHour === 0 ? 12 : startHour),
                    ampm: startHour >= 12 ? 'PM' : 'AM'
                };
                endTime = {
                    hour: endHour > 12 ? endHour - 12 : (endHour === 0 ? 12 : endHour),
                    ampm: endHour >= 12 ? 'PM' : 'AM'
                };
            } else {
                // Reset times to default
                startTime = { hour: 10, ampm: 'AM' };
                endTime = { hour: 11, ampm: 'AM' };
            }
            
            // Initialize clock numbers
            initializeClockNumbers('start');
            initializeClockNumbers('end');
            
            // Update clock hands
            updateClockHands('start');
            updateClockHands('end');
            
            // Update displays
            updateTimeDisplay('start');
            updateTimeDisplay('end');
            
            // Set AM/PM buttons
            updateAmPmButtons('start');
            updateAmPmButtons('end');
            
            // Add drag event listeners
            addDragListeners('start');
            addDragListeners('end');
        }

        function addDragListeners(clockType) {
            const clock = document.getElementById(`${clockType}Clock`);
            
            // Mouse events
            clock.addEventListener('mousedown', (e) => handleDragStart(e, clockType));
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);
            
            // Touch events for mobile
            clock.addEventListener('touchstart', (e) => handleDragStart(e, clockType));
            document.addEventListener('touchmove', handleDragMove);
            document.addEventListener('touchend', handleDragEnd);
        }

        function initializeClockNumbers(clockType) {
            const numbersContainer = document.getElementById(`${clockType}ClockNumbers`);
            numbersContainer.innerHTML = '';
            
            for (let i = 1; i <= 12; i++) {
                const number = document.createElement('div');
                number.className = 'clock-number';
                number.textContent = i;
                
                const angle = (i * 30) - 90; // 30 degrees per hour, -90 to start at 12
                const radius = 45; // Distance from center
                const x = 50 + radius * Math.cos(angle * Math.PI / 180);
                const y = 50 + radius * Math.sin(angle * Math.PI / 180);
                
                number.style.left = x + '%';
                number.style.top = y + '%';
                
                numbersContainer.appendChild(number);
            }
        }

        function handleDragStart(event, clockType) {
            event.preventDefault();
            isDragging = true;
            dragClockType = clockType;
            
            const clientX = event.clientX || (event.touches && event.touches[0].clientX);
            const clientY = event.clientY || (event.touches && event.touches[0].clientY);
            
            const clock = document.getElementById(`${clockType}Clock`);
            const rect = clock.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const clickX = clientX - centerX;
            const clickY = clientY - centerY;
            const clockRadius = rect.width / 2;
            
            // Disable transitions during drag for smooth movement
            const clockHand = document.getElementById(`${clockType}ClockHand`);
            clockHand.style.transition = 'none';
            
            // Update time based on initial position
            updateTimeFromPosition(clockType, clickX, clickY, clockRadius);
        }

        function handleDragMove(event) {
            if (!isDragging) return;
            
            event.preventDefault();
            
            const clientX = event.clientX || (event.touches && event.touches[0].clientX);
            const clientY = event.clientY || (event.touches && event.touches[0].clientY);
            
            const clock = document.getElementById(`${dragClockType}Clock`);
            const rect = clock.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const clickX = clientX - centerX;
            const clickY = clientY - centerY;
            const clockRadius = rect.width / 2;
            
            updateTimeFromPosition(dragClockType, clickX, clickY, clockRadius);
        }

        function handleDragEnd(event) {
            if (!isDragging) return;
            
            isDragging = false;
            
            // Re-enable transitions with smooth snap
            const clockHand = document.getElementById(`${dragClockType}ClockHand`);
            clockHand.style.transition = 'transform 0.3s ease-out';
            
            // Snap to exact hour position
            updateClockHands(dragClockType);
            
            dragClockType = null;
        }

        function updateTimeFromPosition(clockType, clickX, clickY, clockRadius) {
            const angle = Math.atan2(clickY, clickX) * 180 / Math.PI;
            const normalizedAngle = (angle + 90 + 360) % 360;
            
            // Snap to nearest hour (30 degrees per hour)
            const hourAngle = Math.round(normalizedAngle / 30) * 30;
            const hour = Math.round(hourAngle / 30) % 12;
            const adjustedHour = hour === 0 ? 12 : hour;
            
            const time = clockType === 'start' ? startTime : endTime;
            time.hour = adjustedHour;
            
            updateClockHands(clockType);
            updateTimeDisplay(clockType);
        }

        function updateClockHands(clockType) {
            const time = clockType === 'start' ? startTime : endTime;
            const clockHand = document.getElementById(`${clockType}ClockHand`);
            
            // Convert to 24-hour format for calculations
            let hour24 = time.hour;
            if (time.ampm === 'PM' && time.hour !== 12) hour24 += 12;
            if (time.ampm === 'AM' && time.hour === 12) hour24 = 0;
            
            const hourAngle = hour24 * 30; // 30 degrees per hour
            
            clockHand.style.transform = `translate(-50%, -100%) rotate(${hourAngle}deg)`;
        }

        function updateTimeDisplay(clockType) {
            const time = clockType === 'start' ? startTime : endTime;
            const display = document.getElementById(`${clockType}TimeDisplay`);
            
            const hourStr = time.hour.toString().padStart(2, '0');
            
            display.textContent = `${hourStr}:00 ${time.ampm}`;
        }

        function setAmPm(clockType, ampm) {
            if (clockType === 'start') {
                startTime.ampm = ampm;
            } else {
                endTime.ampm = ampm;
            }
            
            updateAmPmButtons(clockType);
            updateTimeDisplay(clockType);
        }

        function updateAmPmButtons(clockType) {
            const time = clockType === 'start' ? startTime : endTime;
            const buttons = document.querySelectorAll(`#${clockType}Clock`).item(0).parentElement.querySelectorAll('.am-pm-btn');
            
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === time.ampm) {
                    btn.classList.add('active');
                }
            });
        }

        function closeTimePicker() {
            document.getElementById('timePickerModal').classList.remove('active');
            currentEditingDate = null;
        }

        async function loadTimePickerSlots(dateStr) {
            try {
                console.log('loadTimePickerSlots called for date:', dateStr);
                const existingSlots = await getTimeSlotsForDate(dateStr, true); // Admin view
                const container = document.getElementById('timePickerSlots');
                
                if (!container) {
                    console.error('timePickerSlots container not found');
                    return;
                }
                
                if (existingSlots.length === 0) {
                    container.innerHTML = '<p style="color: #ccc; text-align: center; padding: 20px;">No time slots yet. Add one below!</p>';
                    return;
                }

                container.innerHTML = '';
                existingSlots.forEach(slot => {
                    const slotDiv = document.createElement('div');
                    slotDiv.className = 'time-slot-item';
                    slotDiv.innerHTML = `
                        <span class="time">${slot.startTime} - ${slot.endTime}</span>
                        <button class="remove-btn" onclick="removeTimeSlotFromModal(${slot.id})">Remove</button>
                    `;
                    container.appendChild(slotDiv);
                });
                console.log('Time picker slots loaded successfully');
            } catch (error) {
                console.error('Error in loadTimePickerSlots:', error);
                const container = document.getElementById('timePickerSlots');
                if (container) {
                    container.innerHTML = '<p style="color: #ff6b6b; text-align: center; padding: 20px;">Error loading time slots</p>';
                }
            }
        }

        async function addTimeFromModal() {
            console.log('=== addTimeFromModal START ===');
            console.log('currentEditingDate:', currentEditingDate);
            console.log('startTime:', startTime);
            console.log('endTime:', endTime);
            
            const startTimeStr = formatTimeString(startTime);
            const endTimeStr = formatTimeString(endTime);
            
            console.log('startTimeStr:', startTimeStr);
            console.log('endTimeStr:', endTimeStr);
            
            if (!currentEditingDate) {
                alert('Error: No date selected');
                return;
            }

            // Show loading animation immediately
            showRocketLoadingAnimation();

            // Check if we're editing an existing booking
            if (window.currentEditingBookingId) {
                console.log('Editing existing booking:', window.currentEditingBookingId);
                // Edit existing approved booking - remove it and create new submission
                const approvedBookings = await getApprovedBookings();
                const booking = approvedBookings.find(b => b.id === window.currentEditingBookingId);
                
                if (booking) {
                    // Remove the approved booking and time slot (handled by API when creating new submission)
                    // Create new submission for the new date/time
                    const submissions = await getSubmissions();
                    const newSubmission = {
                        id: Date.now().toString(),
                        companyName: booking.companyName,
                        email: booking.email,
                        date: currentEditingDate,
                        timeSlot: {
                            time: `${startTimeStr} - ${endTimeStr}`,
                            startTime: startTimeStr,
                            endTime: endTimeStr
                        },
                        website: booking.website,
                        foodType: booking.foodType,
                        submittedAt: new Date().toISOString(),
                        approved: false,
                        rejected: false
                    };
                    // Close the modal immediately so user can continue
                    closeTimePicker();
                    
                    // Submit new submission to Google Sheets in the background
                    submitToGoogleSheets('submit', newSubmission, async () => {
                        // Hide animation after processing
                        hideRocketLoadingAnimation();
                        
                        // Refresh calendars
                        await loadAdminCalendar();
                        updateCalendar();
                        
                        // Show success message
                        alert(`Booking for ${booking.companyName} has been moved to ${currentEditingDate} at ${startTimeStr} - ${endTimeStr}. It will appear as a new submission.`);
                        
                        // Clear editing state
                        window.currentEditingBookingId = null;
                    });
                }
                return;
            }

            console.log('Adding new time slot...');
            
            // Check if adding this slot would exceed monthly submission limit
            const monthYear = currentEditingDate.substring(0, 7); // YYYY-MM
            const submissions = await getSubmissions();
            const existingSubmissionsThisMonth = submissions.filter(submission => 
                submission.date.startsWith(monthYear)
            );
            
            if (existingSubmissionsThisMonth.length >= 3) {
                const slotNumber = existingSubmissionsThisMonth.length + 1;
                const confirmMessage = `You already have ${existingSubmissionsThisMonth.length} submissions for ${monthYear}. Are you sure you want to add a ${slotNumber}${getOrdinalSuffix(slotNumber)} time slot?`;
                
                if (!confirm(confirmMessage)) {
                    // Hide animation if user cancels
                    hideRocketLoadingAnimation();
                    return;
                }
            }

            // Prepare timeSlot data for Google Sheets
            // Column A: Random ID, Column B: Date, Column C: Start Time, Column D: End Time, Column E: Created At
            const randomId = 'ID_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const createdAt = new Date().toISOString();
            
            const timeSlotData = {
                id: randomId,
                date: currentEditingDate,
                startTime: startTimeStr,
                endTime: endTimeStr,
                createdAt: createdAt
            };

            console.log('timeSlot data:', timeSlotData);
            console.log('GOOGLE_SHEETS_URL:', GOOGLE_SHEETS_URL);
            
            // Close the modal immediately so user can add more time slots
            closeTimePicker();
            
            // Submit to Google Sheets in the background
            submitToGoogleSheets('', timeSlotData, async () => {
                // Wait a moment for Google Sheets to process
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                try {
                    // Invalidate caches to force fresh data (same pattern as delete/reject)
                    adminCalendarDataCache.loaded = false;
                    adminCalendarDataCache.timeSlots = null;
                    adminCalendarDataCache.submissions = null;
                    adminCalendarDataCache.approvedBookings = null;
                    
                    calendarDataCache.loaded = false;
                    calendarDataCache.timeSlots = null;
                    calendarDataCache.submissions = null;
                    calendarDataCache.approvedBookings = null;
                    
                    // Reload data with fresh cache (same pattern as delete/reject)
                    await preloadAdminCalendarData();
                    await preloadCalendarData();
                    
                    // Refresh all calendars to show the new time slot
                    loadTimePickerSlots(currentEditingDate);
                    await loadAdminCalendar();
                    await updateCalendar(); // Refresh main calendar view
                    
                    hideRocketLoadingAnimation();
                    console.log('âœ… Calendar refreshed after adding time slot');
                    
                    // Reset clocks for next entry
                    initializeClocks();
                    
                    alert(`ðŸš€ Time slot added successfully: ${startTimeStr} - ${endTimeStr} on ${currentEditingDate}`);
                } catch (error) {
                    hideRocketLoadingAnimation();
                    console.error('âŒ Error refreshing calendar:', error);
                    alert('Time slot may have been added, but there was an error refreshing the calendar. Please refresh the page.');
                }
            });
            
            console.log('=== addTimeFromModal END ===');
        }

        // Generate AI Invitation
        async function generateAIInvitation(submissionId) {
            const modal = document.getElementById('invitationModal');
            const loadingDiv = document.getElementById('invitationLoading');
            const textDiv = document.getElementById('invitationText');
            const actionsDiv = document.getElementById('invitationActions');
            
            if (!modal || !loadingDiv || !textDiv || !actionsDiv) {
                console.error('Invitation modal elements not found');
                return;
            }
            
            // Show modal
            modal.classList.add('active');
            loadingDiv.style.display = 'block';
            textDiv.style.display = 'none';
            actionsDiv.style.display = 'none';
            loadingDiv.innerHTML = 'Generating invitation with AI...';
            
            try {
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'generate-invitation',
                        submissionId: submissionId
                    })
                });
                
                const resultText = await response.text();
                let result;
                try {
                    result = JSON.parse(resultText);
                } catch (e) {
                    console.error('Failed to parse response:', resultText);
                    loadingDiv.innerHTML = `<p style="color: red;">Error: Failed to parse response</p>`;
                    return;
                }
                
                if (result.success) {
                    loadingDiv.style.display = 'none';
                    textDiv.style.display = 'block';
                    textDiv.textContent = result.invitation;
                    actionsDiv.style.display = 'flex';
                    window.currentInvitation = result.invitation;
                } else {
                    loadingDiv.innerHTML = `<p style="color: red;">Error: ${result.error || 'Failed to generate invitation'}</p>`;
                }
            } catch (error) {
                console.error('Error generating invitation:', error);
                loadingDiv.innerHTML = `<p style="color: red;">Error generating invitation. Please try again.</p>`;
            }
        }

        // Close invitation modal
        function closeInvitationModal() {
            const modal = document.getElementById('invitationModal');
            if (modal) {
                modal.classList.remove('active');
            }
            window.currentInvitation = null;
        }

        // Copy invitation to clipboard
        function copyInvitation() {
            if (window.currentInvitation) {
                navigator.clipboard.writeText(window.currentInvitation).then(() => {
                    alert('Invitation copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    // Fallback: select text
                    const textDiv = document.getElementById('invitationText');
                    if (textDiv) {
                        const range = document.createRange();
                        range.selectNodeContents(textDiv);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                        try {
                            document.execCommand('copy');
                            alert('Invitation copied to clipboard!');
                        } catch (e) {
                            alert('Failed to copy invitation. Please select and copy manually.');
                        }
                    }
                });
            }
        }

        function getOrdinalSuffix(num) {
            const j = num % 10;
            const k = num % 100;
            if (j == 1 && k != 11) return "st";
            if (j == 2 && k != 12) return "nd";
            if (j == 3 && k != 13) return "rd";
            return "th";
        }

        function formatTimeString(time) {
            const hourStr = time.hour.toString().padStart(2, '0');
            return `${hourStr}:00 ${time.ampm}`;
        }

        async function removeTimeSlotFromModal(slotId) {
            if (confirm('Are you sure you want to remove this time slot?')) {
                submitToGoogleSheets('delete', { id: slotId }, async () => {
                    loadTimePickerSlots(currentEditingDate);
                    await loadAdminCalendar();
                    await updateCalendar(); // Refresh main calendar view
                });
            }
        }



        async function loadSubmissionsList() {
            console.log('ðŸ“‹ Loading submissions list...');
            const container = document.getElementById('submissionsList');
            if (!container) {
                console.error('âŒ submissionsList container not found!');
                return;
            }
            
            container.innerHTML = '<p>Loading submissions...</p>';
            
            try {
                const submissions = await getSubmissions(); // Fetch from Google Sheets
                console.log(`ðŸ“‹ Got ${submissions.length} submissions to display`);
                
                // Debug: Log all submissions
                console.log('ðŸ“‹ ALL SUBMISSIONS ARRAY:', submissions);
                if (submissions.length > 0) {
                    console.log('ðŸ“‹ Submission IDs:', submissions.map(s => s.id));
                    console.log('ðŸ“‹ Submission company names:', submissions.map(s => s.companyName));
                    console.log('ðŸ“‹ Submission statuses:', submissions.map(s => ({ 
                        id: s.id, 
                        company: s.companyName,
                        status: s.status, 
                        approved: s.approved, 
                        rejected: s.rejected 
                    })));
                } else {
                    console.warn('âš ï¸âš ï¸âš ï¸ SUBMISSIONS ARRAY IS EMPTY! âš ï¸âš ï¸âš ï¸');
                    console.warn('This means either:');
                    console.warn('1. The Submissions sheet in Google Sheets is empty');
                    console.warn('2. The App Script is not reading the data correctly');
                    console.warn('3. The response format is wrong');
                }
                
                container.innerHTML = '';

                if (submissions.length === 0) {
                    container.innerHTML = '<p style="color: #ff9900; padding: 20px; text-align: center; background: rgba(255,153,0,0.1); border: 2px solid #ff9900; border-radius: 8px;">âš ï¸ No submissions found.<br><br>Check:<br>1. Google Sheets "Submissions" tab has data<br>2. Browser console for errors</p>';
                    console.log('âš ï¸ No submissions found - check Google Sheets Submissions tab');
                    return;
                }

            submissions.forEach((submission, index) => {
                console.log(`ðŸ“‹ Processing submission ${index + 1}/${submissions.length}:`, {
                    id: submission.id,
                    company: submission.companyName,
                    email: submission.email,
                    date: submission.date,
                    status: submission.status
                });
                const submissionDiv = document.createElement('div');
                submissionDiv.className = `submission-item ${submission.approved ? 'approved' : ''}`;
                submissionDiv.style.cursor = 'pointer';
                submissionDiv.style.backgroundColor = submission.approved ? 'rgba(0, 255, 0, 0.1)' : 'rgba(255, 255, 0, 0.15)';
                submissionDiv.style.border = `1px solid ${submission.approved ? '#00ff00' : '#ffff00'}`;
                submissionDiv.style.borderRadius = '4px';
                submissionDiv.style.padding = '10px';
                submissionDiv.style.marginBottom = '10px';
                submissionDiv.onclick = () => showSubmissionDetails(submission.date, [submission]);
                
                const statusText = submission.approved ? 
                    '<span style="color: #ffff00;">âœ“ Approved</span>' :
                    `<button class="btn-approve" onclick="event.stopPropagation(); approveSubmission('${submission.id}')">Approve</button>
                     <button class="btn-reject" onclick="event.stopPropagation(); rejectSubmissionDirect('${submission.id}')">Reject</button>`;
                
                submissionDiv.innerHTML = `
                    <div class="submission-details">
                        <div class="submission-detail">
                            <strong>Company:</strong>
                            ${submission.companyName}
                        </div>
                        <div class="submission-detail">
                            <strong>Email:</strong>
                            ${submission.email}
                        </div>
                        <div class="submission-detail">
                            <strong>Date & Time:</strong>
                            ${submission.date} at ${(submission.startTime && submission.endTime) 
                                ? `${formatTimeDisplay(submission.startTime)} - ${formatTimeDisplay(submission.endTime)}`
                                : (submission.timeSlot?.time || 'N/A')}
                        </div>
                        <div class="submission-detail">
                            <strong>Website:</strong>
                            <a href="${submission.website}" target="_blank" style="color: #00ff00;" onclick="event.stopPropagation();">${submission.website}</a>
                        </div>
                        <div class="submission-detail">
                            <strong>Food:</strong>
                            ${submission.foodType}
                        </div>
                        <div class="submission-detail">
                            <strong>Submitted:</strong>
                            ${submission.submittedAt ? new Date(submission.submittedAt).toLocaleString() : 'N/A'}
                        </div>
                    </div>
                    <div class="submission-actions" onclick="event.stopPropagation();">
                        ${statusText}
                        <button class="btn-ai-invitation" onclick="event.stopPropagation(); generateAIInvitation('${submission.id}')" style="margin-left: 10px;">
                            âœ‰ï¸ Click for AI Invitation
                        </button>
                    </div>
                `;
                container.appendChild(submissionDiv);
                console.log(`âœ… Added submission ${index + 1} to DOM:`, submission.id);
            });
            
            const displayedCount = container.children.length;
            console.log(`âœ… Displayed ${displayedCount} submissions in list (expected ${submissions.length})`);
            
            if (displayedCount !== submissions.length) {
                console.warn(`âš ï¸ Mismatch: Expected ${submissions.length} submissions but only ${displayedCount} were added to DOM`);
            }
            } catch (error) {
                console.error('âŒ Error loading submissions list:', error);
                console.error('Error stack:', error.stack);
                container.innerHTML = `<p style="color: #ff0000; padding: 20px;">Error loading submissions: ${error.message}<br><br>Please check console for details.</p>`;
            }
        }

        function addTimeSlot() {
            const datetimeInput = document.getElementById('newTimeSlot');
            const datetime = datetimeInput.value;
            
            if (!datetime) {
                alert('Please select a date and time');
                return;
            }

            const dateTime = new Date(datetime);
            // Use local date methods to avoid timezone conversion issues
            const year = dateTime.getFullYear();
            const month = String(dateTime.getMonth() + 1).padStart(2, '0');
            const day = String(dateTime.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            const timeStr = dateTime.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });

            const timeSlots = getTimeSlots();
            const newSlot = {
                id: Date.now(),
                date: dateStr,
                time: timeStr
            };

            // Add time slot to Google Sheets
            submitToGoogleSheets('', newSlot, async () => {
                loadTimeSlotsList();
            });
            datetimeInput.value = '';
        }

        async function removeTimeSlot(slotId) {
            if (confirm('Are you sure you want to remove this time slot?')) {
                submitToGoogleSheets('delete', { id: slotId }, async () => {
                    await loadAdminCalendar();
                    await updateCalendar(); // Refresh main calendar view
                });
            }
        }

        async function approveSubmission(submissionId) {
            if (!submissionId) {
                alert('Error: No submission ID found.');
                return;
            }

            console.log('âœ… PROCESSING APPROVAL:', submissionId);

            // Get submission data
            const submissions = await getSubmissions();
            const submission = submissions.find(s => String(s.id || '').trim() === String(submissionId || '').trim());
            
            if (!submission) {
                alert('Error: Submission not found!');
                return;
            }

            const originalCount = submissions.length;
            console.log('ðŸ“Š BEFORE APPROVAL:');
            console.log('- Submission ID:', submissionId);
            console.log('- Company:', submission.companyName);
            console.log('- Total submissions:', originalCount);

            // Close submission details modal if open
            closeSubmissionDetails();

            // Send approve request - Apps Script will find by ID, copy to Accepted, delete from Submissions
            const approveData = {
                submissionId: submissionId,
                timeSlotId: submission.timeSlotId || ''
            };

            console.log('ðŸ“¤ Sending approve request to Google Sheets...');
            console.log('ðŸ“‹ Approve data:', approveData);

            // Show loading animation
            showRocketLoadingAnimation();
            
            // Simple form submission - no iframe reading (CORS issues)
            // Just send the request and poll to verify deletion
            console.log('ðŸš€ Calling submitToGoogleSheets with action=approve');
            submitToGoogleSheets('approve', approveData, () => {
                console.log('âœ… Approve request sent to Google Sheets');
            });
            console.log('âœ… submitToGoogleSheets called, starting polling...');

            // Wait a moment for backend to process, then poll to verify
            setTimeout(async () => {
                const approvedId = String(submissionId).trim();
                const startTs = Date.now();
                const maxWaitMs = 15000;
                const pollIntervalMs = 2000;
                let pollAttempts = 0;
                const maxAttempts = Math.floor(maxWaitMs / pollIntervalMs);

                const pollForApproval = async () => {
                    pollAttempts++;
                    console.log(`ðŸ” Polling attempt ${pollAttempts}/${maxAttempts}...`);
                    
                    try {
                        const subs = await getSubmissions();
                        const approvedSubmission = subs.find(s => String(s.id || '').trim() === approvedId);
                        const isApproved = approvedSubmission && (approvedSubmission.status === 'APPROVED' || approvedSubmission.approved === true);
                        
                        console.log(`ðŸ“Š Poll ${pollAttempts}: Found submission`);
                        console.log(`- Submission ${approvedId} is approved:`, isApproved);
                        
                        if (isApproved) {
                            // Submission was approved - success!
                            console.log('âœ… CONFIRMED: Submission approved!');
                            
                            // Refresh caches after approval - clear cache data first
                            adminCalendarDataCache.loaded = false;
                            adminCalendarDataCache.timeSlots = null;
                            adminCalendarDataCache.submissions = null;
                            adminCalendarDataCache.approvedBookings = null;
                            
                            calendarDataCache.loaded = false;
                            calendarDataCache.timeSlots = null;
                            calendarDataCache.submissions = null;
                            calendarDataCache.approvedBookings = null;
                            
                            // Reload data with fresh cache
                            await preloadAdminCalendarData();
                            await preloadCalendarData();
                            
                            await loadAdminCalendar();
                            try { 
                                await updateCalendar(); 
                            } catch (error) { 
                                console.log('Calendar update error:', error); 
                            }
                            await loadSubmissionsList();
                            
                            // Hide loading animation
                            hideRocketLoadingAnimation();
                            
                            const timeDisplay = (submission.startTime && submission.endTime) 
                                ? `${formatTimeDisplay(submission.startTime)} - ${formatTimeDisplay(submission.endTime)}`
                                : 'N/A';
                            alert(`âœ… Submission approved!\n\nâœ“ Status updated to APPROVED\nâœ“ Calendar refreshed\n\nEmail would be sent to ${submission.email} confirming their appointment for ${submission.date} at ${timeDisplay}.`);
                            return;
                        }
                    } catch (e) {
                        console.error('Polling error:', e);
                    }
                    
                    if (Date.now() - startTs < maxWaitMs && pollAttempts < maxAttempts) {
                        setTimeout(pollForApproval, pollIntervalMs);
                    } else {
                        console.error('âŒ POLLING TIMEOUT');
                        const finalSubs = await getSubmissions();
                        const finalApprovedSubmission = finalSubs.find(s => String(s.id || '').trim() === approvedId);
                        const finalIsApproved = finalApprovedSubmission && (finalApprovedSubmission.status === 'APPROVED' || finalApprovedSubmission.approved === true);
                        console.log('- Final submission count:', finalSubs.length);
                        console.log('- Submission is approved:', finalIsApproved);
                        
                        // Always refresh the calendar even on timeout
                        adminCalendarDataCache.loaded = false;
                        adminCalendarDataCache.timeSlots = null;
                        adminCalendarDataCache.submissions = null;
                        adminCalendarDataCache.approvedBookings = null;
                        
                        calendarDataCache.loaded = false;
                        calendarDataCache.timeSlots = null;
                        calendarDataCache.submissions = null;
                        calendarDataCache.approvedBookings = null;
                        
                        await preloadAdminCalendarData();
                        await preloadCalendarData();
                        
                        await loadAdminCalendar();
                        try { 
                            await updateCalendar(); 
                        } catch (error) { 
                            console.log('Calendar update error:', error); 
                        }
                        await loadSubmissionsList();
                        
                        hideRocketLoadingAnimation();
                        
                        if (finalIsApproved) {
                            const timeDisplay = (submission.startTime && submission.endTime) 
                                ? `${formatTimeDisplay(submission.startTime)} - ${formatTimeDisplay(submission.endTime)}`
                                : 'N/A';
                            alert(`âœ… Submission approved!\n\nâœ“ Status updated to APPROVED\nâœ“ Calendar refreshed\n\nEmail would be sent to ${submission.email} confirming their appointment for ${submission.date} at ${timeDisplay}.`);
                        } else {
                            alert('âš ï¸ Approval may have failed. Please check Google Sheets:\n1. Submissions sheet - submission should have Status = APPROVED\n2. Calendar should show the approved booking with ðŸ”’ icon');
                        }
                    }
                };
                
                // Start polling
                pollForApproval();
            }, 2000); // Wait 2 seconds for backend to process
        }

        // Rejection Modal Functions (no longer used - simplified rejection)
        let currentRejectingSubmissionId = null;

        // Show rejection modal when Reject button is clicked
        // Simplified rejection - directly copy to Rejections and delete from Submissions
        async function rejectSubmissionDirect(submissionId) {
            if (!submissionId) {
                alert('Error: No submission ID found.');
                return;
            }

            console.log('ðŸš« PROCESSING REJECTION:', submissionId);

            // Get submission data
            const submissions = await getSubmissions();
            const submission = submissions.find(s => String(s.id || '').trim() === String(submissionId || '').trim());
            
            if (!submission) {
                alert('Error: Submission not found!');
                return;
            }

            const originalCount = submissions.length;
            console.log('ðŸ“Š BEFORE REJECTION:');
            console.log('- Submission ID:', submissionId);
            console.log('- Company:', submission.companyName);
            console.log('- Total submissions:', originalCount);

            // Close submission details modal if open
            closeSubmissionDetails();

            // Show loading animation while processing rejection
            showRocketLoadingAnimation();

            // Send reject request - Apps Script will find by ID, copy to Rejections, delete from Submissions
            const rejectData = {
                submissionId: submissionId,
                rejectionMessage: '', // No message needed - just copy and delete
                timeSlotId: submission.timeSlotId || '',
                date: submission.date || '',
                startTime: submission.startTime || '',
                endTime: submission.endTime || '',
                companyName: submission.companyName || '',
                email: submission.email || ''
            };

            console.log('ðŸ“¤ Sending reject request to Google Sheets...');
            console.log('ðŸ“‹ Reject data:', rejectData);

            // Simple form submission - no iframe reading (CORS issues)
            // Just send the request and poll to verify deletion
            console.log('ðŸš€ Calling submitToGoogleSheets with action=reject');
            submitToGoogleSheets('reject', rejectData, () => {
                console.log('âœ… Reject request sent to Google Sheets');
            });
            console.log('âœ… submitToGoogleSheets called, starting polling...');

            // Wait a moment for backend to process, then poll to verify
            setTimeout(async () => {
                const rejectedId = String(submissionId).trim();
                const startTs = Date.now();
                const maxWaitMs = 15000;
                const pollIntervalMs = 2000;
                let pollAttempts = 0;
                const maxAttempts = Math.floor(maxWaitMs / pollIntervalMs);

                const pollForRemoval = async () => {
                    pollAttempts++;
                    console.log(`ðŸ” Polling attempt ${pollAttempts}/${maxAttempts}...`);
                    
                    try {
                        const subs = await getSubmissions();
                        const currentCount = subs.length;
                        const stillExists = subs.some(s => String(s.id || '').trim() === rejectedId);
                        
                        console.log(`ðŸ“Š Poll ${pollAttempts}: Found ${currentCount} submissions (was ${originalCount})`);
                        console.log(`- Submission ${rejectedId} still exists:`, stillExists);
                        
                        if (!stillExists && currentCount < originalCount) {
                            // Submission was removed - success!
                            console.log('âœ… CONFIRMED: Submission removed from Submissions sheet!');
                            console.log('- Count changed from', originalCount, 'to', currentCount);
                            
                            // Refresh caches after rejection - clear cache data first
                            adminCalendarDataCache.loaded = false;
                            adminCalendarDataCache.timeSlots = null;
                            adminCalendarDataCache.submissions = null;
                            adminCalendarDataCache.approvedBookings = null;
                            
                            calendarDataCache.loaded = false;
                            calendarDataCache.timeSlots = null;
                            calendarDataCache.submissions = null;
                            calendarDataCache.approvedBookings = null;
                            
                            // Reload data with fresh cache
                            await preloadAdminCalendarData();
                            await preloadCalendarData();
                            
                            await loadAdminCalendar();
                            try { 
                                await updateCalendar(); 
                            } catch (error) { 
                                console.log('Calendar update error:', error); 
                            }
                            await loadSubmissionsList();
                            
                            // Hide loading animation after calendar is refreshed
                            hideRocketLoadingAnimation();
                            
                            alert('âœ… Submission rejected!\n\nâœ“ Copied to Rejections sheet\nâœ“ Removed from Submissions sheet');
                            return;
                        }
                    } catch (e) {
                        console.error('Polling error:', e);
                        // Hide loading animation on error
                        hideRocketLoadingAnimation();
                    }
                    
                    if (Date.now() - startTs < maxWaitMs && pollAttempts < maxAttempts) {
                        setTimeout(pollForRemoval, pollIntervalMs);
                    } else {
                        console.error('âŒ POLLING TIMEOUT');
                        const finalSubs = await getSubmissions();
                        const finalStillExists = finalSubs.some(s => String(s.id || '').trim() === rejectedId);
                        console.log('- Final submission count:', finalSubs.length, '(was', originalCount, ')');
                        console.log('- Submission still exists:', finalStillExists);
                        
                        if (!finalStillExists) {
                            // Submission was removed even if polling timed out
                            // Refresh caches after rejection - clear cache data first
                            adminCalendarDataCache.loaded = false;
                            adminCalendarDataCache.timeSlots = null;
                            adminCalendarDataCache.submissions = null;
                            adminCalendarDataCache.approvedBookings = null;
                            
                            calendarDataCache.loaded = false;
                            calendarDataCache.timeSlots = null;
                            calendarDataCache.submissions = null;
                            calendarDataCache.approvedBookings = null;
                            
                            // Reload data with fresh cache
                            await preloadAdminCalendarData();
                            await preloadCalendarData();
                            
                            await loadAdminCalendar();
                            await loadSubmissionsList();
                            
                            // Hide loading animation after calendar is refreshed
                            hideRocketLoadingAnimation();
                            
                            alert('âœ… Submission rejected!\n\nâœ“ Copied to Rejections sheet\nâœ“ Removed from Submissions sheet');
                        } else {
                            // Hide loading animation even if rejection failed
                            hideRocketLoadingAnimation();
                            alert('âš ï¸ Rejection may have failed. The submission still exists.\n\nPlease check Google Sheets:\n1. Submissions sheet - submission should be DELETED\n2. Rejections sheet - submission should be COPIED');
                        }
                    }
                };

                // Start polling
                pollForRemoval();
            }, 2000); // Wait 2 seconds for backend to process
        }


        // Close rejection modal when clicking outside
        document.getElementById('rejectionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelRejection();
            }
        });

        // Close time picker when clicking outside
        document.getElementById('timePickerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTimePicker();
            }
        });

    </script>

    <!-- AI Invitation Modal -->
    <div class="invitation-modal" id="invitationModal">
        <div class="invitation-content">
            <button class="invitation-close" onclick="closeInvitationModal()">Ã—</button>
            <h2>ðŸ“§ AI Generated Invitation</h2>
            <div id="invitationLoading" class="invitation-loading">Generating invitation with AI...</div>
            <div id="invitationText" class="invitation-text" style="display: none;"></div>
            <div class="invitation-actions" id="invitationActions" style="display: none;">
                <button class="btn-copy-invitation" onclick="copyInvitation()">ðŸ“‹ Copy Invitation</button>
                <button class="btn-close-invitation" onclick="closeInvitationModal()">Close</button>
            </div>
        </div>
    </div>

</body>
</html>
